<!DOCTYPE html>
<html lang="es">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Visor Forestal ACOPAC - OSRO</title>
    
    <!-- Librer√≠as desde CDN -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.0/proj4.js"></script>
    <script src="https://unpkg.com/@mapbox/togeojson@0.16.0/togeojson.js"></script>

    <style>
        :root {
            --primary-color: #10b981; 
            --primary-dark: #059669;  
            --accent-color: #3b82f6;  
            --text-main: #111827;     
            --text-light: #4b5563;    
            --bg-surface: #ffffff;
            --shadow-float: 0 4px 12px rgba(0,0,0,0.15);
            --radius-lg: 16px;
            --touch-target: 48px; 
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body, html { 
            height: 100%; width: 100%; overflow: hidden; 
            background: #f3f4f6;
            font-family: 'Inter', sans-serif;
            font-size: 16px;
            color: var(--text-main);
            overscroll-behavior: none;
        }
        
        #map { 
            height: 100vh; width: 100%; z-index: 1; background: #e5e7eb; display: none; 
            touch-action: none;
        }

        /* --- MODALES --- */
        #legal-modal, #login-modal, #nav-setup-modal, #coord-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(5px);
            z-index: 20000; justify-content: center; align-items: center; padding: 20px;
            animation: fadeIn 0.3s ease;
        }
        #legal-modal { display: flex; }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        #login-modal > div {
            animation: slideUp 0.4s ease;
        }
        
        #login-user:focus, #login-pin:focus {
            outline: none;
            border-color: #10b981 !important;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1) !important;
        }
        
        #login-user:hover, #login-pin:hover {
            border-color: #d1d5db !important;
        }
        
        
        .legal-content, .coord-content {
            background: white; width: 100%; max-width: 600px;
            border-radius: 12px; display: flex; flex-direction: column;
            max-height: 90vh; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            overflow: hidden; position: relative;
        }
        
        .legal-header { 
            padding: 24px 20px; 
            border-bottom: 1px solid #e5e7eb; 
            background: #f9fafb; 
            text-align: center; 
        }
        .legal-header h2 { 
            font-size: 20px; 
            color: var(--primary-dark); 
            margin: 0; 
            font-weight: 900;
            line-height: 1.3;
        }
        .legal-body { 
            padding: 24px; 
            overflow-y: auto; 
            font-size: 14px; 
            line-height: 1.6; 
            color: #374151; 
            text-align: left;
        }
        .legal-body p { margin-bottom: 16px; }
        .legal-body strong { color: #111827; }
        .legal-body ul { margin-left: 20px; margin-bottom: 16px; }
        .legal-body li { margin-bottom: 8px; }
        .legal-footer, .coord-btn-group { 
            padding: 20px 24px; 
            border-top: 1px solid #e5e7eb; 
            background: #fff; 
            display: flex; 
            gap: 12px; 
        }
        
        .btn-accept, .coord-btn-primary { 
            background: var(--primary-color); 
            color: white; 
            border: none; 
            padding: 14px 20px; 
            border-radius: 8px; 
            font-weight: 700; 
            flex: 1; 
            cursor: pointer;
            font-size: 15px;
            transition: all 0.2s;
        }
        .btn-accept:hover, .coord-btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }
        .btn-cancel, .coord-btn-cancel { 
            background: #fee2e2; 
            color: #b91c1c; 
            border: 1px solid #fecaca; 
            padding: 14px 20px; 
            border-radius: 8px; 
            font-weight: 600; 
            flex: 1; 
            cursor: pointer;
            font-size: 15px;
            transition: all 0.2s;
        }
        .btn-cancel:hover, .coord-btn-cancel:hover {
            background: #fecaca;
            transform: translateY(-1px);
        }

        /* --- UI MAPA --- */
        .leaflet-touch .leaflet-bar { border: none; box-shadow: var(--shadow-float); border-radius: 12px; margin-bottom: 12px; }
        .leaflet-touch .leaflet-bar a { width: var(--touch-target); height: var(--touch-target); line-height: var(--touch-target); font-size: 20px; color: #374151; background: white; }
        .leaflet-top { top: 12px; } .leaflet-left { left: 12px; } .leaflet-right { right: 12px; } .leaflet-bottom { bottom: 24px; }
        .leaflet-draw { display: none; }
        
        .leaflet-draw-toolbar { margin-top: 12px !important; box-shadow: var(--shadow-float) !important; border: none !important; border-radius: 12px !important; background: white; display: flex; flex-direction: column; }
        .leaflet-draw-toolbar a { background-image: none !important; background-color: white !important; width: var(--touch-target) !important; height: var(--touch-target) !important; line-height: var(--touch-target) !important; border-bottom: 1px solid #f3f4f6 !important; display: flex !important; justify-content: center; align-items: center; color: #4b5563; }
        .leaflet-draw-edit-edit::before { content: '‚úèÔ∏è'; font-size: 16px; } 
        .leaflet-draw-edit-remove::before { content: 'üóëÔ∏è'; font-size: 16px; }
        .leaflet-draw-draw-polyline::before { content: '„Ä∞Ô∏è'; font-size: 16px; } 
        .leaflet-draw-draw-polygon::before { content: '‚¨†'; font-size: 16px; }
        
        /* --- MENU FLOTANTE COMPLETO (de super5/6) --- */
        #filter-container {
            position: absolute; 
            top: 10px; 
            right: 10px; 
            z-index: 2000;
            display: none;
            width: 34px; 
            flex-direction: column;
            font-size: 12px; 
            align-items: flex-end; 
        }
        
        #filter-container.menu-open {
            width: 240px; 
            align-items: stretch; 
        }

        #menu-toggle-btn {
            background: white;
            color: #464646;
            padding: 0;
            border-radius: 4px;
            border: 2px solid rgba(0,0,0,0.2);
            cursor: pointer;
            font-weight: bold;
            font-size: 18px;
            box-shadow: none;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 34px;
            height: 34px;
            transition: background-color 0.2s;
        }
        
        #menu-toggle-btn:hover { background-color: #f4f4f4; }
        
        #menu-content {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 12px;
            margin-top: 5px;
            display: none;
            border: none;
            max-height: 80vh;
            overflow-y: auto;
            opacity: 0;
        }
        
        #filter-container.menu-open #menu-content {
            display: block;
            animation: slideDown 0.2s ease-out forwards;
        }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .menu-section {
            margin-bottom: 12px;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 8px;
        }
        .menu-section:last-child {
            margin-bottom: 0;
            border-bottom: none;
            padding-bottom: 0;
        }
        
        .section-title {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-light);
            font-weight: 700;
            margin-bottom: 6px;
            display: block;
        }

        .layer-item {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
            cursor: pointer;
            font-size: 13px;
            color: var(--text-main);
            padding: 2px 0;
        }
        .layer-item:hover { color: var(--primary-color); }
        .layer-item input[type="radio"],
        .layer-item input[type="checkbox"] {
            margin-right: 8px;
            accent-color: var(--primary-color);
            cursor: pointer;
            width: 16px;
            height: 16px;
        }

        select, input[type="text"] {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 13px;
            background: white;
            color: var(--text-main);
            outline: none;
            margin-bottom: 8px;
        }

        .tool-btn {
            display: block;
            width: 100%;
            padding: 10px 12px;
            margin-bottom: 6px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            color: var(--text-main);
            font-weight: 500;
            transition: all 0.2s;
            text-align: left;
        }
        .tool-btn:hover { 
            background: #f9fafb; 
            border-color: var(--primary-color); 
            color: var(--primary-dark);
        }
        
        #reload-btn {
            background: #f0fdf4;
            color: var(--primary-dark);
            border-color: #bbf7d0;
            margin-top: 8px;
            text-align: center;
            font-weight: 600;
        }
        #reload-btn:hover { background: #dcfce7; }
        
        #help-btn {
            text-align: center;
            margin-top: 8px;
        }

        /* --- √ÅRBOLES Y POPUPS --- */
        .tree-marker {
            border-radius: 50%;
            border: 2px solid #ffffff; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.6);
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: pointer;
        }
        .tree-marker:hover { 
            transform: scale(1.6); 
            z-index: 1000 !important; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.5); 
            border-color: #f3f4f6;
        }
        
        .status-aprobado { background-color: #7c3aed; } 
        .status-denegado { background-color: #ef4444; } 
        .status-unknown { background-color: #f59e0b; } 

        .tree-label {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid #d1d5db;
            border-radius: 6px;
            padding: 2px 6px;
            font-weight: 700;
            font-size: 11px;
            color: var(--text-main);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            white-space: nowrap;
            pointer-events: none;
            font-family: 'Inter', sans-serif;
        }

        .leaflet-popup-content-wrapper { 
            border-radius: 12px; 
            padding: 0; 
            overflow: hidden;
        } 
        
        .leaflet-popup-content { 
            margin: 0; 
            width: 300px !important; 
        }
        
        .popup-header { 
            background: #f9fafb; 
            padding: 14px; 
            border-bottom: 1px solid #e5e7eb;
            font-weight: 600;
            font-size: 14px;
            color: #111827;
        } 
        
        .popup-body { 
            padding: 16px; 
            max-height: 250px; 
            overflow-y: auto; 
            font-size: 13px; 
            line-height: 1.5;
        }
        
        .popup-row { 
            display: flex; 
            justify-content: space-between; 
            padding: 6px 0; 
            border-bottom: 1px solid #f3f4f6;
            font-size: 12px;
        }
        
        .popup-row:last-child { border-bottom: none; }
        
        .popup-row span { color: #6b7280; }
        .popup-row b { color: #111827; }

        /* --- DASHBOARD NAVEGACI√ìN (de SUPER7) --- */
        #nav-dashboard {
            background: #0f172a;
            color: white;
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10002;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        #nav-target-info {
            position: absolute;
            top: 40px;
            background: rgba(255,255,255,0.1);
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            color: #cbd5e1;
            font-weight: 500;
        }
        
        #nav-arrow-container {
            width: 60vw;
            height: 60vw;
            max-width: 280px;
            max-height: 280px;
            background: #1e293b;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 8px solid #334155;
            margin-bottom: 40px;
        }
        
        #nav-arrow {
            font-size: 30vw;
            color: var(--primary-color);
            max-font-size: 120px;
        }
        
        .nav-metrics {
            display: flex;
            width: 100%;
            justify-content: space-around;
            margin-bottom: 30px;
            padding: 0 20px;
        }
        
        .nav-metric-item {
            text-align: center;
        }
        
        .nav-metric-label {
            font-size: 14px;
            color: #94a3b8;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .nav-metric-val {
            font-size: 32px;
            font-weight: 800;
        }
        
        .nav-metric-val.large {
            font-size: 48px;
            color: var(--primary-color);
        }
        
        #nav-stop-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 18px 52px;
            border-radius: 100px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            position: absolute;
            bottom: 40px;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
            transition: all 0.2s;
        }
        
        #nav-stop-btn:hover {
            background: #dc2626;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
        }

        .leaflet-control-scale-line { 
            border: 2px solid #374151; 
            border-top: none; 
            background: rgba(255,255,255,0.9); 
            font-weight: 700; 
            font-size: 11px; 
            margin-bottom: 5px; 
            margin-right: 10px; 
        }
        
        /* --- LOADER y NOTIFICACIONES --- */
        #loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #f9fafb;
            z-index: 9998;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        
        .spinner {
            border: 3px solid #e5e7eb;
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 0.8s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .notification {
            position: fixed;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 350px;
            background: #1f2937;
            color: white;
            text-align: center;
            border: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
            border-radius: 16px;
            padding: 16px;
            font-size: 15px;
            font-weight: 600;
            z-index: 10000;
            display: none;
        }
        
        .notification.success { border-bottom: 4px solid var(--primary-color); }
        .notification.error { border-bottom: 4px solid #ef4444; }
        
        /* --- PANEL DE AYUDA --- */
        #help-panel {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: var(--shadow-float);
            z-index: 10001;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        #help-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.4);
            backdrop-filter: blur(2px);
            z-index: 10000;
        }
        
        /* --- LEGEND --- */
        .leaflet-control.legend {
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            font-size: 12px;
            line-height: 1.4;
        }
        
        .legend h4 {
            margin: 0 0 8px 0;
            font-size: 13px;
            font-weight: 600;
            color: #111827;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 4px;
        }
        
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            border: 2px solid white;
        }
    </style>
</head>
<body>

    <!-- AVISO LEGAL ACTUALIZADO -->
    <div id="legal-modal">
        <div class="legal-content">
            <div class="legal-header">
                <h2>VISOR DE APROVECHAMIENTO FORESTAL<br>ACOPAC-OSRO</h2>
            </div>
            <div class="legal-body">
                <p><strong>LEA ATENTAMENTE ESTOS T√âRMINOS ANTES DE ACCEDER A LA PLATAFORMA.</strong></p>
                
                <p>Al ingresar sus credenciales y acceder a este sistema, usted (en adelante, el "Usuario/Funcionario") acepta obligarse por los siguientes t√©rminos y condiciones de uso del Visor de Aprovechamiento Forestal (en adelante, el "Software"), propiedad del Sistema Nacional de √Åreas de Conservaci√≥n (SINAC).</p>
                
                <p><strong>1. NATURALEZA Y PROPIEDAD</strong><br>
                El Software es una herramienta de uso estrictamente interno e institucional. Los derechos patrimoniales de propiedad intelectual, que incluyen la explotaci√≥n, distribuci√≥n y uso exclusivo de la herramienta, pertenecen al SINAC como entidad titular de la obra creada bajo relaci√≥n de servicio.</p>
                
                <p><strong>2. LICENCIA DE USO Y RESTRICCIONES</strong><br>
                Se otorga al Funcionario una licencia personal, intransferible y no exclusiva para acceder al Software √∫nicamente para fines oficiales de cumplimiento de sus funciones. Queda terminantemente prohibido:</p>
                
                <ul>
                    <li>Compartir contrase√±as o mecanismos de autenticaci√≥n con terceros o compa√±eros no autorizados.</li>
                    <li>Extraer masivamente datos para fines ajenos a la funci√≥n p√∫blica.</li>
                    <li>Publicar capturas de pantalla, archivos descargables o informaci√≥n contenida en el Software en redes sociales, medios de comunicaci√≥n o cualquier plataforma externa.</li>
                </ul>
                
                <p><strong>3. CONFIDENCIALIDAD DE LOS DATOS</strong><br>
                El Software contiene informaci√≥n sensible y datos personales de administrados, protegidos por la Ley de Protecci√≥n de la Persona frente al Tratamiento de sus Datos Personales (Ley 8968). El Funcionario asume la obligaci√≥n legal de guardar el m√°s estricto sigilo y confidencialidad sobre los datos aqu√≠ consultados.</p>
                
                <p><strong>4. R√âGIMEN DISCIPLINARIO Y SANCIONATORIO</strong><br>
                El incumplimiento de estos t√©rminos, la negligencia en el resguardo de las credenciales o la divulgaci√≥n desautorizada de informaci√≥n se considera una falta grave al deber de probidad y sigilo. Las sanciones aplicables incluyen:</p>
                
                <p><em>Administrativas:</em> Suspensi√≥n sin goce de salario o despido sin responsabilidad patronal, de conformidad con el art√≠culo 113 de la Ley 62 Ver Ley 62 , Adiciona el reglamento interior del Congreso. 10-09-1834 y el art√≠culo 14 de la Ley 7727 Ver Ley 7727, Resoluci√≥n Alterna de Conflictos y Promoci√≥n de la Paz Social RAC. 09-12-1997.</p>
                
                <p><em>Civiles:</em> Responsabilidad personal del funcionario por los da√±os y perjuicios ocasionados al administrado o a la Administraci√≥n P√∫blica Ver Ley 7766, Tratado de Extradici√≥n con Espa√±a. 24-04-1998.</p>
                
                <p><em>Penales:</em> Denuncia ante el Ministerio P√∫blico por delitos de violaci√≥n de datos personales (Art. 196 bis C√≥digo Penal), revelaci√≥n de secretos o acceso desautorizado a sistemas inform√°ticos.</p>
                
                <p><strong>5. ESTADO DEL SOFTWARE Y LIMITACIONES T√âCNICAS</strong><br>
                El Software se encuentra actualmente en <strong>fase de prueba y validaci√≥n (BETA)</strong>. Como herramienta en desarrollo continuo, puede presentar errores, funcionalidades en proceso de mejora o comportamientos no esperados. El uso del sistema durante esta fase tiene como objetivos: (a) detectar y reportar errores t√©cnicos, (b) determinar requerimientos de mejora funcional, (c) evaluar la experiencia de usuario en condiciones reales de campo, y (d) validar la precisi√≥n y confiabilidad de los datos geogr√°ficos.</p>
                
                <p><strong>Precisi√≥n GPS y Geolocalizaci√≥n:</strong><br>
                El Software utiliza la tecnolog√≠a GPS del dispositivo m√≥vil del usuario para determinar ubicaciones geogr√°ficas. La precisi√≥n t√≠pica de GPS en smartphones comerciales oscila entre ¬±3 y ¬±10 metros en condiciones ideales de cielo despejado, pudiendo degradarse significativamente bajo cobertura forestal densa, en ca√±ones urbanos, o en condiciones meteorol√≥gicas adversas. Los datos de ubicaci√≥n mostrados en el visor son aproximaciones y <strong>no deben ser considerados como levantamientos topogr√°ficos oficiales</strong>. Para trabajos que requieran precisi√≥n centim√©trica o m√©trica certificada (demarcaciones de linderos, informes periciales, resoluciones legales), es obligatorio realizar levantamientos con equipo geod√©sico profesional y metodolog√≠a diferencial con estaciones de referencia CORS del Instituto Geogr√°fico Nacional (IGN).</p>
                
                <p><strong>Sistema de Coordenadas Oficial:</strong><br>
                El Software utiliza exclusivamente el sistema de coordenadas oficial de la Rep√∫blica de Costa Rica: <strong>CR-SIRGAS / CRTM05 (EPSG:8908)</strong>, establecido mediante Decreto Ejecutivo N¬∞ 40962-MJP del 11 de abril de 2018 y ratificado por la Norma T√©cnica NTIG_CR01_06.2023 V2 del Instituto Geogr√°fico Nacional. Este sistema reemplaz√≥ al anterior CR05 / CRTM05 (EPSG:5367) y se basa en el datum geod√©sico CR-SIRGAS (ligado a ITRF2008 √©poca 2014.59) con elipsoide de referencia GRS 1980. Todas las coordenadas proyectadas CRTM05 desplegadas en el visor corresponden a este sistema oficial vigente. Las transformaciones a coordenadas geogr√°ficas (latitud/longitud) se realizan conforme a los par√°metros oficiales de proyecci√≥n Transversa de Mercator publicados por el IGN.</p>
                
                <p><strong>6. ACEPTACI√ìN</strong><br>
                El ingreso al Software constituye la aceptaci√≥n plena y sin reservas de estos t√©rminos. El Funcionario declara ser consciente de las responsabilidades legales que conlleva el manejo de la informaci√≥n institucional aqu√≠ alojada, as√≠ como de las limitaciones t√©cnicas inherentes a la tecnolog√≠a GPS y al estado de desarrollo actual del sistema.</p>
                
                <p><strong>7. CR√âDITOS Y PROPIEDAD INTELECTUAL</strong><br>
                Esta herramienta digital ha sido desarrollada por Ing. Pablo C√©sar S√°nchez N√∫√±ez, Encargado de Aprovechamiento Forestal de la Oficina Subregional de Orotina (ACOPAC-SINAC). De conformidad con los art√≠culos 13 y 14 de la Ley de Derechos de Autor y Derechos Conexos (N¬∞ 6683), se reconoce al autor el derecho moral de paternidad sobre la obra, el cual es personal√≠simo, inalienable e irrenunciable, facult√°ndole de forma perpetua a reivindicar su autor√≠a y a exigir la menci√≥n de su nombre en toda reproducci√≥n o uso institucional. Si bien los derechos patrimoniales pertenecen al SINAC por la naturaleza de la relaci√≥n laboral, el reconocimiento del autor intelectual es un derecho protegido constitucionalmente. Para soporte t√©cnico o consultas, contactar a: <strong style="color: #059669;"><a href="mailto:pablo.sanchez@sinac.go.cr">pablo.sanchez@sinac.go.cr</a></strong></p>
            </div>
            <div class="legal-footer">
                <button class="btn-cancel" onclick="closeApp()">Cancelar</button>
                <button class="btn-accept" onclick="acceptLegal()">Aceptar e Ingresar</button>
            </div>
        </div>
    </div>

    <!-- LOGIN (de SUPER7) -->
    <div id="login-modal">
        <div style="background: white; width: 100%; max-width: 420px; border-radius: 24px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; position: relative;">
            <!-- Header con gradiente -->
            <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 40px 24px 60px 24px; text-align: center; position: relative;">
                <!-- Logo circular -->
                <div style="width: 120px; height: 120px; margin: 0 auto 20px auto; background: white; border-radius: 50%; padding: 15px; box-shadow: 0 8px 24px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center;">
                    <img src="data:image/webp;base64,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" 
                         alt="SINAC Logo" 
                         style="width: 100%; height: 100%; object-fit: contain;">
                </div>
                
                <!-- T√≠tulo -->
                <h2 style="color: white; font-size: 24px; font-weight: 900; margin: 0 0 8px 0; text-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    Visor Forestal ACOPAC
                </h2>
                <p style="color: rgba(255,255,255,0.9); font-size: 14px; margin: 0; font-weight: 500;">
                    Sistema de Gesti√≥n Forestal - OSRO
                </p>
            </div>
            
            <!-- Cuerpo del formulario -->
            <div style="padding: 32px 24px 24px 24px; margin-top: -30px; background: white; border-radius: 24px 24px 0 0; position: relative;">
                <div style="background: #f9fafb; border-radius: 12px; padding: 20px; margin-bottom: 24px;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                        <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                <circle cx="12" cy="7" r="4"></circle>
                            </svg>
                        </div>
                        <div style="flex: 1;">
                            <label style="display: block; font-size: 12px; font-weight: 700; color: #6b7280; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">
                                üë§ Funcionario/a
                            </label>
                            <select id="login-user" style="width: 100%; padding: 10px 12px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 11px; font-weight: 500; color: #111827; background: white; cursor: pointer; transition: all 0.2s;">
                                <option value="">Seleccione su usuario...</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #3b82f6, #2563eb); border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                                <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                            </svg>
                        </div>
                        <div style="flex: 1;">
                            <label style="display: block; font-size: 12px; font-weight: 700; color: #6b7280; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">
                                üîë PIN Seguro
                            </label>
                            <input type="password" 
                                   id="login-pin" 
                                   placeholder="‚Ä¢‚Ä¢‚Ä¢" 
                                   inputmode="numeric" 
                                   maxlength="3"
                                   style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 15px; font-weight: 600; color: #111827; background: white; transition: all 0.2s;">
                        </div>
                    </div>
                </div>
                
                <!-- Estado de carga de usuarios -->
                <div id="login-status" style="display: none; padding: 12px; background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 8px; margin-bottom: 16px; text-align: center; font-size: 13px; color: #1e40af;">
                    üîÑ Cargando usuarios...
                </div>
                
                <!-- Bot√≥n de ingreso -->
                <button onclick="processLogin()" 
                        style="width: 100%; padding: 16px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 700; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); margin-bottom: 16px;"
                        onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(16, 185, 129, 0.4)';"
                        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(16, 185, 129, 0.3)';">
                    üöÄ Ingresar al Sistema
                </button>
                
                <!-- Bot√≥n volver -->
                <button onclick="location.reload()" 
                        style="width: 100%; padding: 12px; background: transparent; color: #6b7280; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s;"
                        onmouseover="this.style.background='#f9fafb'; this.style.borderColor='#d1d5db';"
                        onmouseout="this.style.background='transparent'; this.style.borderColor='#e5e7eb';">
                    ‚Üê Volver
                </button>
                
                <!-- Footer info -->
                <div style="margin-top: 24px; padding-top: 20px; border-top: 1px solid #f3f4f6; text-align: center;">
                    <p style="font-size: 11px; color: #9ca3af; margin: 0; line-height: 1.5;">
                        üîí Acceso seguro ‚Ä¢ Sistema SINAC<br>
                        Oficina Subregional Orotina - ACOPAC
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- MEN√ö FLOTANTE COMPLETO (de super5/6) -->
    <div id="filter-container">
        <button id="menu-toggle-btn" onclick="toggleMenu()" title="Men√∫">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#464646" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="3" y1="12" x2="21" y2="12"></line>
                <line x1="3" y1="6" x2="21" y2="6"></line>
                <line x1="3" y1="18" x2="21" y2="18"></line>
            </svg>
        </button>
        
        <div id="menu-content">
            <!-- SECCI√ìN FILTROS -->
            <div class="menu-section">
                <span class="section-title">Filtros</span>
                <label for="expediente-filter" style="display: block; font-size: 11px; margin-bottom: 4px; color: var(--text-main);">Expediente</label>
                <select id="expediente-filter">
                    <option value="all">Todos los Expedientes</option>
                </select>
                <div id="filter-stats" style="margin-top: 4px; font-size: 10px; color: var(--text-light); text-align: right;">Cargando...</div>
            </div>

            <!-- SECCI√ìN HERRAMIENTAS COMPLETAS -->
            <div class="menu-section">
                <span class="section-title">Herramientas</span>
                <button class="tool-btn" onclick="openNavSetup()">üß≠ Navegar a √Årbol</button>
                <button class="tool-btn" onclick="showCoordModal()">üìç Ir a Coordenada</button>
                <button class="tool-btn" onclick="document.getElementById('gpx-input').click()">üó∫Ô∏è Cargar GPX/KML</button>
                <button class="tool-btn" onclick="clearGPXLayers()">üóëÔ∏è Limpiar GPX</button>
                <button class="tool-btn" onclick="toggleDrawingTools()">üìê Medici√≥n</button>
                <button class="tool-btn" onclick="clearDrawings()">üßπ Limpiar Mediciones</button>
            </div>

            <!-- SECCI√ìN CAPAS -->
            <div class="menu-section">
                <span class="section-title">Capas</span>
<label class="layer-item">
                    <input type="checkbox" id="show-labels" checked>
                    Etiquetas √Årboles
                </label>
            </div>

            <!-- SECCI√ìN MAPAS BASE -->
            <div class="menu-section">
                <span class="section-title">Mapas Base</span>
                <label class="layer-item">
                    <input type="radio" name="baselayer" value="google" checked onchange="changeBaseLayer('google')">
                    Google H√≠brido
                </label>
                <label class="layer-item">
                    <input type="radio" name="baselayer" value="bing" onchange="changeBaseLayer('bing')">
                    Bing Sat√©lite
                </label>
                <label class="layer-item">
                    <input type="radio" name="baselayer" value="esri" onchange="changeBaseLayer('esri')">
                    Esri Sat√©lite
                </label>
                <label class="layer-item">
                    <input type="radio" name="baselayer" value="osm" onchange="changeBaseLayer('osm')">
                    OpenStreetMap
                </label>
            </div>
            
            <!-- SECCI√ìN SISTEMA -->
            <div class="menu-section">
                <span class="section-title">Sistema</span>
                <div id="cache-info" style="font-size: 11px; color: #6b7280; padding: 8px; background: #f9fafb; border-radius: 6px; margin-bottom: 8px;">
                    <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px;">
                        <span id="cache-status-icon">üì°</span>
                        <span id="cache-status-text" style="font-weight: 600;">Conectado</span>
                    </div>
                    <div id="cache-last-update" style="font-size: 10px; color: #9ca3af;">
                        √öltima actualizaci√≥n: --
                    </div>
                </div>
            </div>

            <!-- ACCIONES FINALES -->
            <div class="menu-section" style="border:none;">
                <button class="tool-btn" id="admin-btn" onclick="showAdminPanel()" style="display:none; background:linear-gradient(135deg, #ef4444, #dc2626); color:white;">‚öôÔ∏è Administraci√≥n</button>
                <button class="tool-btn" id="reload-btn" onclick="manualReload()">üîÑ Recargar Datos</button>
                <button class="tool-btn" id="help-btn" onclick="showHelp()">‚ùì Ayuda</button>
            </div>
        </div>
    </div>

    <!-- DASHBOARD NAVEGACI√ìN MEJORADO -->
    <div id="nav-dashboard">
        <!-- Info del destino -->
        <div id="nav-target-info">Destino</div>
        
        <!-- Indicadores de estado en la parte superior -->
        <div style="display: flex; justify-content: space-between; width: 100%; padding: 0 20px; margin-bottom: 15px;">
            <!-- Indicador de calidad GPS -->
            <div style="display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.1); padding: 8px 12px; border-radius: 20px;">
                <span style="font-size: 12px; color: #94a3b8;">GPS:</span>
                <div id="nav-gps-quality" style="display: flex; gap: 2px; align-items: flex-end; height: 18px;"></div>
                <span id="nav-gps-quality-text" style="font-size: 11px; color: #94a3b8;">--</span>
            </div>
            
            <!-- Indicador de confiabilidad de br√∫jula -->
            <div style="display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.1); padding: 8px 12px; border-radius: 20px;">
                <span style="font-size: 12px; color: #94a3b8;">Br√∫jula:</span>
                <div id="nav-confidence-indicator" style="width: 12px; height: 12px; border-radius: 50%; background: #6b7280; transition: all 0.3s;"></div>
                <span id="nav-confidence-text" style="font-size: 11px; color: #94a3b8;">--</span>
            </div>
        </div>
        
        <!-- Advertencia de calibraci√≥n -->
        <div id="nav-calibration-warning" style="display: none; background: rgba(245, 158, 11, 0.2); border: 1px solid #f59e0b; color: #fbbf24; padding: 10px 15px; border-radius: 10px; margin-bottom: 15px; font-size: 12px; text-align: center; width: calc(100% - 40px);"></div>
        
        <!-- Contenedor de la flecha con indicador de confianza -->
        <div id="nav-arrow-container" style="transition: border-color 0.3s, opacity 0.3s;">
            <div id="nav-arrow">‚¨Ü</div>
        </div>
        
        <!-- M√©trica principal: Distancia -->
        <div class="nav-metrics">
            <div class="nav-metric-item">
                <div class="nav-metric-label">Distancia</div>
                <div class="nav-metric-val large" id="nav-dist">0</div>
                <div style="font-size: 14px; color: #64748b;">metros</div>
            </div>
        </div>
        
        <!-- M√©tricas secundarias -->
        <div class="nav-metrics">
            <div class="nav-metric-item">
                <div class="nav-metric-label">Rumbo al destino</div>
                <div class="nav-metric-val" id="nav-bearing">0¬∞</div>
            </div>
            <div class="nav-metric-item">
                <div class="nav-metric-label">Precisi√≥n GPS</div>
                <div class="nav-metric-val" id="nav-accuracy" style="transition: color 0.3s;">--</div>
            </div>
        </div>
        
        <!-- Info t√©cnica (m√°s peque√±a) -->
        <div class="nav-metrics" style="opacity: 0.5; font-size: 10px; margin-top: 5px;">
            <div class="nav-metric-item">
                <div class="nav-metric-label" style="font-size: 9px;">Tu orientaci√≥n</div>
                <div class="nav-metric-val" style="font-size: 11px;" id="nav-device-heading">--</div>
            </div>
            <div class="nav-metric-item">
                <div class="nav-metric-label" style="font-size: 9px;">Lecturas GPS</div>
                <div class="nav-metric-val" style="font-size: 11px;" id="nav-gps-buffer">0/5</div>
            </div>
        </div>
        
        <!-- Leyenda de confiabilidad -->
        <div style="display: flex; gap: 15px; justify-content: center; margin-top: 15px; font-size: 10px; color: #64748b;">
            <div style="display: flex; align-items: center; gap: 4px;">
                <div style="width: 8px; height: 8px; border-radius: 50%; background: #10b981;"></div>
                <span>Confiable</span>
            </div>
            <div style="display: flex; align-items: center; gap: 4px;">
                <div style="width: 8px; height: 8px; border-radius: 50%; background: #f59e0b;"></div>
                <span>Precauci√≥n</span>
            </div>
            <div style="display: flex; align-items: center; gap: 4px;">
                <div style="width: 8px; height: 8px; border-radius: 50%; background: #ef4444;"></div>
                <span>Calibrando</span>
            </div>
        </div>
        
        <button id="nav-stop-btn" onclick="stopNavigation()">SALIR</button>
    </div>

    <!-- MODALES VARIOS -->
    <div id="coord-modal">
        <div class="coord-content">
            <h3>üìç Coordenada CRTM05</h3>
            <p style="font-size: 12px; color: #6b7280; margin-bottom: 15px;">Ingrese coordenadas o toque en el mapa</p>
            <button class="tool-btn" onclick="enableMapPick()" style="margin-bottom: 15px;">üó∫Ô∏è Tocar en Mapa</button>
            <input type="text" id="coord-x" placeholder="Este (X)">
            <input type="text" id="coord-y" placeholder="Norte (Y)" style="margin-top:10px;">
            <div class="coord-btn-group" style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn-cancel" onclick="closeCoordModal()">Cancelar</button>
                <button class="btn-accept" onclick="processCoordSearch()">Ir</button>
            </div>
        </div>
    </div>
    
    <div id="nav-setup-modal">
        <div class="coord-content">
            <h3>üß≠ Navegar a √Årbol</h3>
            <select id="nav-expediente" onchange="updateNavTrees()">
                <option>Seleccione expediente...</option>
            </select>
            <select id="nav-tree">
                <option>Seleccione √°rbol...</option>
            </select>
            <div class="coord-btn-group" style="display:flex; gap:10px;">
                <button class="btn-cancel" onclick="closeNavSetup()">Cancelar</button>
                <button class="btn-accept" onclick="startNavigation()">Navegar</button>
            </div>
        </div>
    </div>

    <!-- LOADER Y NOTIFICACIONES -->
    <div id="loader">
        <div class="spinner"></div>
        <h2 style="font-size: 22px; font-weight: 700; color: #111827; margin-bottom: 8px;">
            Visor Forestal ACOPAC
        </h2>
        <p style="color: #6b7280; font-size: 14px; margin-bottom: 20px;">
            Sincronizando datos...
        </p>
        <div id="debug-log" style="margin-top: 20px; text-align: center; font-size: 12px; color: #6b7280;">
            <span>üöÄ Iniciando sistema...</span>
        </div>
        <button onclick="forceShow()" class="btn-accept" id="btn-force-show" style="display:none; margin-top: 20px;">
            üó∫Ô∏è Ir al Mapa
        </button>
    </div>
    
    <div id="notification" class="notification"></div>
    
    <input type="file" id="gpx-input" accept=".gpx,.kml" multiple style="display:none;">

    <!-- PANEL DE AYUDA -->
    <div id="help-panel">
        <h2 style="font-size: 20px; font-weight: 700; color: var(--text-main); margin-bottom: 20px;">üìñ Gu√≠a del Visor</h2>
        <div style="margin-bottom: 20px;">
            <h3 style="font-size: 14px; font-weight: 600; color: var(--primary-dark); margin-bottom: 10px;">üó∫Ô∏è Navegaci√≥n</h3>
            <ul style="margin-left: 20px; color: var(--text-main); line-height: 1.6; font-size: 13px;">
                <li><strong>Zoom:</strong> Rueda del rat√≥n o botones +/-</li>
                <li><strong>Mover:</strong> Desliza el dedo o clic y arrastrar</li>
                <li><strong>Ubicaci√≥n GPS:</strong> Bot√≥n üìç en controles</li>
                <li><strong>Medici√≥n:</strong> Activar desde men√∫ y dibujar en mapa</li>
            </ul>
        </div>
        <div style="margin-bottom: 20px;">
            <h3 style="font-size: 14px; font-weight: 600; color: var(--primary-dark); margin-bottom: 10px;">üå≥ Simbolog√≠a</h3>
            <ul style="margin-left: 20px; color: var(--text-main); line-height: 1.6; font-size: 13px;">
                <li><span style="color: #7c3aed;">‚óè</span> <strong>P√∫rpura:</strong> Aprobado</li>
                <li><span style="color: #ef4444;">‚óè</span> <strong>Rojo:</strong> Denegado</li>
                <li><span style="color: #f59e0b;">‚óè</span> <strong>Amarillo:</strong> Sin definir</li>
            </ul>
        </div>
        <button onclick="document.getElementById('help-panel').style.display='none'; document.getElementById('help-overlay').style.display='none';" class="btn-accept" style="width: 100%; margin-top: 0;">Entendido</button>
    </div>
    
    <div id="help-overlay" onclick="document.getElementById('help-panel').style.display='none'; this.style.display='none';"></div>
    
    <!-- MODAL DE ADMINISTRACI√ìN -->
    <div id="admin-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:10000; justify-content:center; align-items:center;">
        <div style="background:white; width:90%; max-width:600px; border-radius:16px; padding:32px; max-height:90vh; overflow-y:auto;">
            <h2 style="font-size:22px; font-weight:700; color:#111827; margin-bottom:24px; display:flex; align-items:center; gap:10px;">
                ‚öôÔ∏è Panel de Administraci√≥n
            </h2>
            
            <!-- Configuraci√≥n de URL de datos de √°rboles -->
            <div style="margin-bottom:24px; padding:20px; background:#f9fafb; border-radius:12px;">
                <h3 style="font-size:16px; font-weight:600; color:#374151; margin-bottom:12px;">üìä URL de Datos de √Årboles</h3>
                <p style="font-size:12px; color:#6b7280; margin-bottom:12px;">Ingrese el ID del Google Sheet (valores separados por comas):</p>
                <input type="text" id="admin-sheet-id" placeholder="1H416o9kATBiHPiVXqtCravU4_BnpnrYROCTi7G4BS1A" style="width:100%; padding:12px; border:2px solid #e5e7eb; border-radius:8px; font-size:13px; font-family:monospace; margin-bottom:12px;">
                <button onclick="saveDataSheetConfig()" class="btn-accept" style="width:100%;">üíæ Guardar URL de Datos</button>
            </div>
            
            <!-- Configuraci√≥n de URL de usuarios -->
            <div style="margin-bottom:24px; padding:20px; background:#f9fafb; border-radius:12px;">
                <h3 style="font-size:16px; font-weight:600; color:#374151; margin-bottom:12px;">üë• Configuraci√≥n de Usuarios</h3>
                <p style="font-size:12px; color:#6b7280; margin-bottom:8px;">Puede ingresar cualquiera de estos formatos:</p>
                <ul style="font-size:11px; color:#6b7280; margin-bottom:12px; padding-left:20px; line-height:1.6;">
                    <li><strong>Sheet ID + GID:</strong> 1ABC123xyz:68050674</li>
                    <li><strong>Solo Sheet ID:</strong> 1ABC123xyz</li>
                    <li><strong>URL completa:</strong> https://docs.google.com/.../d/[ID]/edit#gid=...</li>
                </ul>
                <input type="text" id="admin-users-csv" placeholder="Sheet ID o URL completa" style="width:100%; padding:12px; border:2px solid #e5e7eb; border-radius:8px; font-size:11px; font-family:monospace; margin-bottom:12px;">
                <button onclick="saveUsersCSVConfig()" class="btn-accept" style="width:100%;">üíæ Guardar Configuraci√≥n de Usuarios</button>
            </div>
            
            <!-- Lista de usuarios actuales -->
            <div style="margin-bottom:24px; padding:20px; background:#f9fafb; border-radius:12px;">
                <h3 style="font-size:16px; font-weight:600; color:#374151; margin-bottom:12px;">üìã Usuarios Actuales</h3>
                <div id="admin-users-list" style="max-height:200px; overflow-y:auto; font-size:12px; color:#374151; line-height:1.8;">
                    Cargando...
                </div>
                <button onclick="refreshUsersList()" class="btn-accept" style="width:100%; margin-top:12px;">üîÑ Recargar Usuarios</button>
            </div>
            
            <!-- Configuraci√≥n de webhook de logs -->
            <div style="margin-bottom:24px; padding:20px; background:#f9fafb; border-radius:12px;">
                <h3 style="font-size:16px; font-weight:600; color:#374151; margin-bottom:12px;">üìä Sistema de Logs (Auditor√≠a)</h3>
                <p style="font-size:12px; color:#6b7280; margin-bottom:12px;">URL del webhook de Google Apps Script para registrar actividad:</p>
                <input type="text" id="admin-logs-webhook" placeholder="https://script.google.com/macros/s/.../exec" style="width:100%; padding:12px; border:2px solid #e5e7eb; border-radius:8px; font-size:10px; font-family:monospace; margin-bottom:12px;">
                <button onclick="saveLogsWebhookConfig()" class="btn-accept" style="width:100%;">üíæ Guardar Webhook de Logs</button>
                <div style="margin-top:12px; padding:12px; background:#fef3c7; border-radius:8px; font-size:11px; color:#92400e;">
                    <strong>‚ÑπÔ∏è Instrucciones:</strong><br>
                    1. Configura Google Apps Script (ver documentaci√≥n)<br>
                    2. Obt√©n la URL del webhook<br>
                    3. P√©gala aqu√≠<br>
                    4. Los logs se registrar√°n autom√°ticamente en la pesta√±a LOGS
                </div>
            </div>
            
            <!-- Botones de acci√≥n -->
            <div style="display:flex; gap:12px;">
                <button onclick="closeAdminModal()" style="flex:1; padding:14px; background:#e5e7eb; color:#374151; border:none; border-radius:10px; font-size:14px; font-weight:600; cursor:pointer;">
                    ‚Üê Cerrar
                </button>
                <button onclick="location.reload()" class="btn-accept" style="flex:1;">
                    üîÑ Reiniciar Sistema
                </button>
            </div>
        </div>
    </div>
    
    <!-- MAPA -->
    <div id="map"></div>

    <script>
        window.addEventListener('unhandledrejection', function(event) {
            console.warn("Error as√≠ncrono:", event.reason);
            const debugLog = document.getElementById('debug-log');
            if (debugLog) {
                debugLog.innerHTML += `<div style="color: #ef4444">[ERROR] ${event.reason}</div>`;
            }
            const btn = document.getElementById('btn-force-show');
            if(btn) btn.style.display = 'block';
        });

        // ====================================================================
        // CONFIGURACI√ìN GLOBAL
        // ====================================================================
        
        // USUARIOS - SOLO ADMINISTRADOR EN C√ìDIGO
        const ADMIN_USER = {
            name: "Pablo S√°nchez",
            pin: "920",
            isAdmin: true
        };
        
        // Funci√≥n para verificar si un usuario es admin
        function isAdmin(username) {
            return username === "Pablo S√°nchez";
        }
        
        // Base de datos de usuarios (se carga din√°micamente)
        let USERS_DATABASE = {};
        
        // VARIABLES GLOBALES
        let map, allMarkers = [], expedientesSet = new Set(), gpxLayers = [], drawnItems;
        let currentUser = null;
        let currentUserIsAdmin = false;
        let navWatchId, targetLatLng;
        let deviceHeading = 0; // Orientaci√≥n del dispositivo en grados
        let targetBearing = 0; // Rumbo hacia el objetivo
        let orientationSupported = false;
        let layers = {};
        let drawControl, drawToolbarVisible = false;
        let userLocationMarker = null, userLocationCircle = null;
        let autoUpdateTimer = null;
        
        // ====================================================================
        // SISTEMA AVANZADO DE SENSORES Y GPS
        // ====================================================================
        
        // Variables para GPS de alta precisi√≥n
        let gpsWatchId = null;
        let gpsReadings = []; // Buffer de lecturas GPS
        const GPS_BUFFER_SIZE = 5; // N√∫mero de lecturas para promediar
        const GPS_MAX_AGE = 3000; // M√°ximo 3 segundos de antig√ºedad
        const GPS_ACCURACY_THRESHOLD = 20; // Umbral de precisi√≥n aceptable (metros)
        let lastGoodPosition = null;
        let gpsQuality = 'searching'; // 'searching', 'poor', 'fair', 'good', 'excellent'
        
        // Variables para sistema de orientaci√≥n mejorado
        let rawHeading = 0; // Lectura cruda del magnet√≥metro
        let filteredHeading = 0; // Lectura filtrada (suavizada)
        let headingHistory = []; // Historial para filtrado
        const HEADING_BUFFER_SIZE = 10; // Lecturas para promediar
        const HEADING_FILTER_ALPHA = 0.3; // Factor de suavizado (0-1, menor = m√°s suave)
        
        // Variables para sensor fusion
        let accelerometerData = { x: 0, y: 0, z: 0 };
        let gyroscopeData = { alpha: 0, beta: 0, gamma: 0 };
        let magnetometerCalibrated = false;
        let lastOrientationUpdate = 0;
        let orientationConfidence = 0; // 0-100%
        let compassCalibrationNeeded = false;
        
        // Sensores modernos (Generic Sensor API)
        let absoluteOrientationSensor = null;
        let accelerometer = null;
        let gyroscope = null;
        let magnetometer = null;
        let sensorsAvailable = {
            absoluteOrientation: false,
            accelerometer: false,
            gyroscope: false,
            magnetometer: false,
            deviceOrientation: false
        };
        
        // CONFIGURACI√ìN
        const CRTM05_DEF = '+proj=tmerc +lat_0=0 +lon_0=-84 +k=0.9999 +x_0=500000 +y_0=0 +ellps=WGS84 +units=m +no_defs';
        
        // Limpiar configuraci√≥n antigua si tiene URL /pub o Sheet ID obsoleto (migraci√≥n autom√°tica)
        const oldConfig = localStorage.getItem('config_users_csv');
        if (oldConfig && (oldConfig.includes('/pub?') || oldConfig === '19Cz9ZKtUIyt8e15hN0FiTED6f3Vv3qP-osy-vyhY3y4')) {
            console.log("üîÑ Detectada configuraci√≥n antigua, limpiando...");
            localStorage.removeItem('config_users_csv');
            console.log("‚úÖ Configuraci√≥n limpiada, usando Sheet con pesta√±a USUARIOS (gid=68050674)");
        }
        
        // URLs configurables (guardadas en LocalStorage)
        let SHEET_ID_DATA = localStorage.getItem('config_sheet_id') || '1H416o9kATBiHPiVXqtCravU4_BnpnrYROCTi7G4BS1A';
        let GID_DATA = localStorage.getItem('config_gid_data') || '0'; // Pesta√±a ARBOLES
        let CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID_DATA}/export?format=csv&gid=${GID_DATA}`;
        
        // Funci√≥n para normalizar URL de usuarios (convertir cualquier formato al que funciona)
        function normalizeUsersURL(input) {
            // Si es solo un Sheet ID (sin https)
            if (!input.includes('http')) {
                // Si contiene :, es Sheet ID + GID
                if (input.includes(':')) {
                    const [sheetId, gid] = input.split(':');
                    return `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${gid}`;
                }
                // Solo Sheet ID (sin GID)
                return `https://docs.google.com/spreadsheets/d/${input}/export?format=csv`;
            }
            
            // Si es URL con /pub, extraer Sheet ID y convertir a /export
            if (input.includes('/pub?')) {
                const match = input.match(/\/d\/e\/([^\/]+)\//);
                if (match) {
                    console.log("‚ö†Ô∏è Formato /pub detectado, convirtiendo a /export...");
                    return input;
                }
            }
            
            // Si es URL con /d/[ID]/edit o /d/[ID]/export
            const match = input.match(/\/d\/([a-zA-Z0-9-_]+)/);
            if (match) {
                const sheetId = match[1];
                console.log("‚úÖ Sheet ID extra√≠do:", sheetId);
                
                // Buscar GID en la URL
                const gidMatch = input.match(/[#&]gid=(\d+)/);
                if (gidMatch) {
                    const gid = gidMatch[1];
                    console.log("‚úÖ GID extra√≠do:", gid);
                    return `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${gid}`;
                }
                
                return `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv`;
            }
            
            // Si ya es formato correcto o no pudimos procesarlo, devolver tal cual
            return input;
        }
        
        // Configuraci√≥n por defecto: mismo Sheet que √°rboles, pesta√±a USUARIOS (gid=68050674)
        let USERS_CSV_URL = normalizeUsersURL(localStorage.getItem('config_users_csv') || '1H416o9kATBiHPiVXqtCravU4_BnpnrYROCTi7G4BS1A:68050674');
        
        // ====================================================================
        // SISTEMA DE LOGS Y AUDITOR√çA
        // ====================================================================
        
        // URL del webhook de Google Apps Script (se configurar√° despu√©s)
        let LOGS_WEBHOOK_URL = localStorage.getItem('config_logs_webhook') || 'https://script.google.com/macros/s/AKfycbyuF0CWoZ2AaY0ERtunslFB6qHNeI2vARMnHuYlhJbNr1q21KAnkzuPm8bm5xtjJHek/exec';
        
        // Configuraci√≥n de logs
        const LOGS_CONFIG = {
            enabled: true, // Activar/desactivar sistema de logs
            offlineQueue: [], // Cola de logs pendientes cuando no hay conexi√≥n
            maxQueueSize: 100, // M√°ximo de logs en cola
            retryAttempts: 3, // Intentos de reenv√≠o si falla
        };
        
        // Variables de sesi√≥n
        let sessionId = null;
        let deviceId = null;
        let sessionStartTime = null;
        const CORS_PROXIES = [
            '', 'https://api.allorigins.win/raw?url=', 'https://corsproxy.io/?',
            'https://api.codetabs.com/v1/proxy?quest=', 'https://cors-anywhere.herokuapp.com/'
        ];
        
        const AUTO_UPDATE_INTERVAL = 5 * 60 * 1000;

        // ====================================================================
        // FUNCIONES DE INICIO Y LOGIN (de SUPER7)
        // ====================================================================
        
        function closeApp() {
            if (window.history.length > 1) {
                window.history.back();
            } else {
                document.body.innerHTML = '<div style="display:flex;justify-content:center;align-items:center;height:100%;text-align:center;font-family:sans-serif;padding:20px;"><h1>Visor Forestal ACOPAC - Sesi√≥n Cerrada</h1></div>';
            }
        }
        
        function acceptLegal() {
            document.getElementById('legal-modal').style.display = 'none';
            document.getElementById('login-modal').style.display = 'flex';
            
            // Inicializar sistema de logs
            initLogsSystem();
            
            // Agregar admin inmediatamente
            USERS_DATABASE = {};
            USERS_DATABASE[ADMIN_USER.name] = ADMIN_USER.pin;
            
            // Mostrar login inmediatamente con admin
            populateLoginSelect();
            
            // Mostrar mensaje de carga
            const statusDiv = document.getElementById('login-status');
            if (statusDiv) {
                statusDiv.innerHTML = 'üîÑ Cargando usuarios adicionales...';
                statusDiv.style.display = 'block';
            }
            
            // Intentar cargar usuarios del CSV en segundo plano (sin bloquear)
            loadUsersFromCSV();
        }
        
        // ====================================================================
        // FUNCIONES DE ADMINISTRACI√ìN
        // ====================================================================
        
        function loadUsersFromCSV() {
            console.log("üì• Cargando usuarios adicionales desde CSV...");
            console.log("üì• URL:", USERS_CSV_URL);
            
            const statusDiv = document.getElementById('login-status');
            
            // Timeout de seguridad: si no carga en 15 segundos, continuar solo con admin
            const timeoutId = setTimeout(() => {
                console.warn("‚è±Ô∏è Timeout: Carga de usuarios tom√≥ demasiado tiempo");
                if (statusDiv) {
                    statusDiv.innerHTML = '‚ö†Ô∏è Timeout - Solo administrador disponible';
                    statusDiv.style.background = '#fef3c7';
                    statusDiv.style.borderColor = '#fcd34d';
                    statusDiv.style.color = '#92400e';
                }
            }, 15000);
            
            // Verificar que Papa.parse est√© disponible
            if (typeof Papa === 'undefined') {
                console.error("‚ùå Papa.parse no est√° disponible");
                clearTimeout(timeoutId);
                if (statusDiv) {
                    statusDiv.innerHTML = '‚ö†Ô∏è Librer√≠a CSV no disponible - Solo admin';
                    statusDiv.style.background = '#fef3c7';
                    statusDiv.style.borderColor = '#fcd34d';
                    statusDiv.style.color = '#92400e';
                }
                return;
            }
            
            // Funci√≥n para probar con diferentes proxies CORS
            function tryLoadWithProxy(proxyIndex) {
                if (proxyIndex >= CORS_PROXIES.length) {
                    console.error("‚ùå Todos los proxies fallaron al cargar usuarios");
                    clearTimeout(timeoutId);
                    if (statusDiv) {
                        statusDiv.innerHTML = '‚ùå No se pudo conectar al servidor de usuarios<br><small>Solo admin disponible</small>';
                        statusDiv.style.background = '#fee2e2';
                        statusDiv.style.borderColor = '#fca5a5';
                        statusDiv.style.color = '#991b1b';
                    }
                    return;
                }
                
                const url = CORS_PROXIES[proxyIndex] ? 
                    CORS_PROXIES[proxyIndex] + encodeURIComponent(USERS_CSV_URL) : 
                    USERS_CSV_URL;
                
                console.log(`üîÑ Probando proxy ${proxyIndex}: ${CORS_PROXIES[proxyIndex] || 'directo'}`);
                
                if (statusDiv) {
                    statusDiv.innerHTML = `üîÑ Descargando usuarios (m√©todo ${proxyIndex + 1}/${CORS_PROXIES.length})...`;
                }
                
                fetch(url)
                    .then(r => {
                        console.log(`üì° Proxy ${proxyIndex} - Respuesta:`, r.status, r.statusText);
                        if (!r.ok) throw new Error(`HTTP ${r.status}`);
                        return r.text();
                    })
                    .then(txt => {
                        clearTimeout(timeoutId);
                        console.log(`‚úÖ Proxy ${proxyIndex} FUNCION√ì!`);
                        console.log("üìÑ CSV recibido, primeras 300 chars:", txt.substring(0, 300));
                        
                        if (statusDiv) {
                            statusDiv.innerHTML = '‚öôÔ∏è Procesando usuarios...';
                        }
                        
                        try {
                            Papa.parse(txt, {
                                header: true,
                                skipEmptyLines: true,
                                transformHeader: (header) => {
                                    return header.trim().toUpperCase();
                                },
                                complete: (res) => {
                                    console.log("üìä Parseo completado");
                                    console.log("üìã Errores:", res.errors.length);
                                    console.log("üìã Filas:", res.data.length);
                                    
                                    if (res.errors && res.errors.length > 0) {
                                        console.warn("‚ö†Ô∏è Errores en parseo:", res.errors);
                                    }
                                    
                                    if (res.data && res.data.length > 0) {
                                        console.log("üìã Primera fila:", res.data[0]);
                                        console.log("üìã Columnas:", Object.keys(res.data[0]));
                                        
                                        let loadedCount = 0;
                                        res.data.forEach((row, idx) => {
                                            const usuario = row.USUARIO || row.Usuario || row.usuario || 
                                                           row.USER || row.user || row.nombre || row.NOMBRE;
                                            const pin = row.PIN || row.Pin || row.pin || 
                                                       row.codigo || row.CODIGO || row.clave || row.CLAVE;
                                            
                                            if (usuario && pin && usuario.trim() !== '' && pin.trim() !== '') {
                                                if (!isAdmin(usuario.trim())) {
                                                    USERS_DATABASE[usuario.trim()] = pin.trim().toString();
                                                    loadedCount++;
                                                    console.log(`‚úÖ Usuario ${loadedCount}: ${usuario.trim()} (PIN: ${pin.trim()})`);
                                                } else {
                                                    console.log(`‚ÑπÔ∏è Ignorando admin del CSV: ${usuario.trim()}`);
                                                }
                                            } else {
                                                if (idx < 5) {
                                                    console.warn(`‚ö†Ô∏è Fila ${idx} inv√°lida:`, row);
                                                }
                                            }
                                        });
                                        
                                        console.log(`‚úÖ Total usuarios: ${Object.keys(USERS_DATABASE).length} (Admin + ${loadedCount} del CSV)`);
                                        
                                        if (loadedCount > 0) {
                                            if (statusDiv) {
                                                statusDiv.innerHTML = `‚úÖ ${loadedCount} usuario${loadedCount > 1 ? 's' : ''} cargado${loadedCount > 1 ? 's' : ''} desde CSV`;
                                                statusDiv.style.background = '#d1fae5';
                                                statusDiv.style.borderColor = '#6ee7b7';
                                                statusDiv.style.color = '#065f46';
                                            }
                                            populateLoginSelect(); // Actualizar dropdown
                                        } else {
                                            if (statusDiv) {
                                                statusDiv.innerHTML = '‚ö†Ô∏è CSV sin usuarios v√°lidos';
                                                statusDiv.style.background = '#fef3c7';
                                                statusDiv.style.borderColor = '#fcd34d';
                                                statusDiv.style.color = '#92400e';
                                            }
                                        }
                                    } else {
                                        console.warn("‚ö†Ô∏è CSV sin datos");
                                        if (statusDiv) {
                                            statusDiv.innerHTML = '‚ö†Ô∏è CSV vac√≠o, solo admin disponible';
                                            statusDiv.style.background = '#fef3c7';
                                            statusDiv.style.borderColor = '#fcd34d';
                                            statusDiv.style.color = '#92400e';
                                        }
                                    }
                                },
                                error: (err) => {
                                    console.error("‚ùå Error parseando CSV:", err);
                                    clearTimeout(timeoutId);
                                    tryLoadWithProxy(proxyIndex + 1);
                                }
                            });
                        } catch (parseError) {
                            console.error("‚ùå Excepci√≥n al parsear:", parseError);
                            clearTimeout(timeoutId);
                            tryLoadWithProxy(proxyIndex + 1);
                        }
                    })
                    .catch(e => {
                        console.error(`‚ùå Proxy ${proxyIndex} fall√≥:`, e.message);
                        tryLoadWithProxy(proxyIndex + 1);
                    });
            }
            
            // Empezar con el primer proxy (directo sin proxy)
            tryLoadWithProxy(0);
        }
        
        function showAdminPanel() {
            document.getElementById('admin-modal').style.display = 'flex';
            
            // Cargar configuraciones actuales
            document.getElementById('admin-sheet-id').value = SHEET_ID_DATA;
            document.getElementById('admin-users-csv').value = USERS_CSV_URL;
            document.getElementById('admin-logs-webhook').value = LOGS_WEBHOOK_URL;
            
            // Mostrar lista de usuarios
            displayUsersList();
        }
        
        function closeAdminModal() {
            document.getElementById('admin-modal').style.display = 'none';
        }
        
        function saveDataSheetConfig() {
            const newSheetId = document.getElementById('admin-sheet-id').value.trim();
            if (!newSheetId) {
                showNotification("‚ùå Ingrese un ID de Sheet v√°lido", "error");
                return;
            }
            
            SHEET_ID_DATA = newSheetId;
            CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID_DATA}/export?format=csv`;
            
            localStorage.setItem('config_sheet_id', SHEET_ID_DATA);
            
            showNotification("‚úÖ URL de datos guardada. Reinicie para aplicar cambios.", "success");
        }
        
        function saveUsersCSVConfig() {
            const input = document.getElementById('admin-users-csv').value.trim();
            if (!input) {
                showNotification("‚ùå Ingrese un Sheet ID o URL v√°lida", "error");
                return;
            }
            
            // Normalizar la URL (convertir cualquier formato al que funciona)
            USERS_CSV_URL = normalizeUsersURL(input);
            
            // Guardar el input original del usuario
            localStorage.setItem('config_users_csv', input);
            
            console.log("üì• URL original:", input);
            console.log("üì• URL normalizada:", USERS_CSV_URL);
            
            showNotification("‚úÖ URL de usuarios guardada. Reinicie para aplicar cambios.", "success");
        }
        
        function saveLogsWebhookConfig() {
            const webhook = document.getElementById('admin-logs-webhook').value.trim();
            
            // Validar formato b√°sico de URL
            if (webhook && !webhook.startsWith('https://')) {
                showNotification("‚ùå La URL debe comenzar con https://", "error");
                return;
            }
            
            LOGS_WEBHOOK_URL = webhook;
            localStorage.setItem('config_logs_webhook', webhook);
            
            console.log("üìä Webhook de logs guardado:", webhook || '(vac√≠o - logs desactivados)');
            
            if (webhook) {
                showNotification("‚úÖ Webhook guardado. Sistema de logs activado.", "success");
            } else {
                showNotification("‚ö†Ô∏è Webhook vac√≠o. Sistema de logs desactivado.", "info");
            }
        }
        
        function displayUsersList() {
            const container = document.getElementById('admin-users-list');
            const userCount = Object.keys(USERS_DATABASE).length;
            
            let html = `<div style="margin-bottom:8px; font-weight:600; color:#10b981;">Total: ${userCount} usuarios</div>`;
            
            Object.keys(USERS_DATABASE).sort().forEach(user => {
                const userIsAdmin = isAdmin(user);
                const badge = userIsAdmin ? '<span style="background:#ef4444; color:white; padding:2px 8px; border-radius:4px; font-size:10px; margin-left:8px;">ADMIN</span>' : '';
                html += `<div style="padding:8px; background:white; border-radius:6px; margin-bottom:4px; display:flex; justify-content:space-between; align-items:center;">
                    <span>${user}${badge}</span>
                    <span style="font-family:monospace; color:#6b7280;">PIN: ${USERS_DATABASE[user]}</span>
                </div>`;
            });
            
            container.innerHTML = html;
        }
        
        function refreshUsersList() {
            showNotification("üîÑ Recargando usuarios...", "info");
            loadUsersFromCSV();
            setTimeout(() => {
                displayUsersList();
                showNotification("‚úÖ Usuarios recargados", "success");
            }, 1000);
        }
        
        // ====================================================================
        // SISTEMA DE LOGS Y AUDITOR√çA
        // ====================================================================
        
        // Generar o recuperar ID √∫nico del dispositivo
        function getDeviceId() {
            if (deviceId) return deviceId;
            
            let stored = localStorage.getItem('device_id');
            if (!stored) {
                stored = 'dev_' + Math.random().toString(36).substr(2, 9) + Date.now().toString(36);
                localStorage.setItem('device_id', stored);
            }
            deviceId = stored;
            return deviceId;
        }
        
        // Generar ID de sesi√≥n
        function generateSessionId() {
            return 'sess_' + Math.random().toString(36).substr(2, 9) + Date.now().toString(36);
        }
        
        // Detectar tipo de dispositivo
        function getDeviceType() {
            const ua = navigator.userAgent;
            if (/(tablet|ipad|playbook|silk)|(android(?!.*mobi))/i.test(ua)) {
                return 'Tablet';
            }
            if (/Mobile|Android|iP(hone|od)|IEMobile|BlackBerry|Kindle|Silk-Accelerated|(hpw|web)OS|Opera M(obi|ini)/.test(ua)) {
                return 'Mobile';
            }
            return 'Desktop';
        }
        
        // Detectar navegador
        function getBrowser() {
            const ua = navigator.userAgent;
            if (ua.indexOf('Firefox') > -1) return 'Firefox';
            if (ua.indexOf('SamsungBrowser') > -1) return 'Samsung';
            if (ua.indexOf('Opera') > -1 || ua.indexOf('OPR') > -1) return 'Opera';
            if (ua.indexOf('Trident') > -1) return 'IE';
            if (ua.indexOf('Edge') > -1) return 'Edge';
            if (ua.indexOf('Chrome') > -1) return 'Chrome';
            if (ua.indexOf('Safari') > -1) return 'Safari';
            return 'Unknown';
        }
        
        // Enviar log al webhook
        async function sendLog(accion, datosExtra = '') {
            if (!LOGS_CONFIG.enabled) return;
            if (!LOGS_WEBHOOK_URL || LOGS_WEBHOOK_URL === '') {
                console.log('üìä Log (webhook no configurado):', accion, datosExtra);
                return;
            }
            
            const logData = {
                sessionId: sessionId || '',
                usuario: currentUser || '',
                accion: accion,
                fechaHora: new Date().toLocaleString('es-CR', { 
                    timeZone: 'America/Costa_Rica',
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                }),
                dispositivoId: getDeviceId(),
                tipoDispositivo: getDeviceType(),
                navegador: getBrowser(),
                datosExtra: datosExtra
            };
            
            console.log('üìä Enviando log:', logData);
            
            try {
                const response = await fetch(LOGS_WEBHOOK_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(logData)
                });
                
                console.log('‚úÖ Log enviado correctamente');
                
                // Intentar enviar logs pendientes si hay
                if (LOGS_CONFIG.offlineQueue.length > 0) {
                    await sendPendingLogs();
                }
                
            } catch (error) {
                console.warn('‚ö†Ô∏è Error enviando log:', error);
                
                // Guardar en cola offline si hay error
                if (LOGS_CONFIG.offlineQueue.length < LOGS_CONFIG.maxQueueSize) {
                    LOGS_CONFIG.offlineQueue.push(logData);
                    localStorage.setItem('logs_queue', JSON.stringify(LOGS_CONFIG.offlineQueue));
                }
            }
        }
        
        // Enviar logs pendientes
        async function sendPendingLogs() {
            if (LOGS_CONFIG.offlineQueue.length === 0) return;
            
            console.log(`üì§ Enviando ${LOGS_CONFIG.offlineQueue.length} logs pendientes...`);
            
            const logsToSend = [...LOGS_CONFIG.offlineQueue];
            LOGS_CONFIG.offlineQueue = [];
            
            for (const logData of logsToSend) {
                try {
                    await fetch(LOGS_WEBHOOK_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(logData)
                    });
                } catch (error) {
                    // Si falla, volver a agregar a la cola
                    LOGS_CONFIG.offlineQueue.push(logData);
                }
            }
            
            localStorage.setItem('logs_queue', JSON.stringify(LOGS_CONFIG.offlineQueue));
            console.log(`‚úÖ Logs pendientes procesados. Quedan ${LOGS_CONFIG.offlineQueue.length} en cola`);
        }
        
        // Inicializar sistema de logs
        function initLogsSystem() {
            // Cargar cola de logs pendientes
            const storedQueue = localStorage.getItem('logs_queue');
            if (storedQueue) {
                try {
                    LOGS_CONFIG.offlineQueue = JSON.parse(storedQueue);
                } catch (e) {
                    console.warn('Error cargando cola de logs:', e);
                }
            }
            
            console.log('üìä Sistema de logs inicializado');
            console.log('üìä Webhook:', LOGS_WEBHOOK_URL || 'No configurado');
            console.log('üìä Device ID:', getDeviceId());
            console.log('üìä Tipo:', getDeviceType());
            console.log('üìä Navegador:', getBrowser());
        }
        
        // Registrar LOGOUT cuando se cierra la p√°gina
        window.addEventListener('beforeunload', function() {
            if (currentUser && sessionId) {
                const sessionDuration = sessionStartTime ? Math.floor((Date.now() - sessionStartTime) / 1000) : 0;
                const logData = {
                    sessionId: sessionId,
                    usuario: currentUser,
                    accion: 'LOGOUT',
                    fechaHora: new Date().toLocaleString('es-CR', { 
                        timeZone: 'America/Costa_Rica',
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: false
                    }),
                    dispositivoId: getDeviceId(),
                    tipoDispositivo: getDeviceType(),
                    navegador: getBrowser(),
                    datosExtra: `Duraci√≥n sesi√≥n: ${sessionDuration}s`
                };
                
                // Usar sendBeacon para env√≠o confiable al cerrar
                if (navigator.sendBeacon && LOGS_WEBHOOK_URL) {
                    navigator.sendBeacon(LOGS_WEBHOOK_URL, JSON.stringify(logData));
                }
                
                console.log('üìä LOGOUT registrado');
            }
        });

        function populateLoginSelect() {
            const select = document.getElementById('login-user');
            select.innerHTML = '<option value="">Seleccione usuario...</option>';
            
            // Crear lista √∫nica de usuarios (evitar duplicados del admin)
            const uniqueUsers = {};
            Object.keys(USERS_DATABASE).forEach(u => {
                // Si es admin, usar solo el nombre (no el email)
                if (isAdmin(u)) {
                    uniqueUsers[ADMIN_USER.name] = USERS_DATABASE[u];
                } else {
                    uniqueUsers[u] = USERS_DATABASE[u];
                }
            });
            
            Object.keys(uniqueUsers).sort().forEach(u => {
                const opt = document.createElement('option');
                opt.value = u; 
                opt.textContent = u;
                select.appendChild(opt);
            });
            
            console.log("üìã Usuarios en dropdown:", Object.keys(uniqueUsers).length);
        }

        function processLogin() {
            const user = document.getElementById('login-user').value;
            const pin = document.getElementById('login-pin').value;
            
            if(!user) {
                showNotification("Seleccione un usuario", "error");
                return;
            }
            
            if(USERS_DATABASE[user] == pin) {
                currentUser = user;
                currentUserIsAdmin = isAdmin(user);
                
                // Iniciar sesi√≥n y registrar login
                sessionId = generateSessionId();
                sessionStartTime = Date.now();
                
                console.log("‚úÖ Login exitoso:", user);
                console.log("üë§ Es administrador:", currentUserIsAdmin);
                console.log("üîë Session ID:", sessionId);
                
                // Registrar evento de LOGIN
                sendLog('LOGIN', `Usuario: ${user}, Admin: ${currentUserIsAdmin}`);
                
                document.getElementById('login-modal').style.display = 'none';
                document.getElementById('loader').style.display = 'flex';
                
                // Mostrar bot√≥n de admin si es administrador
                if (currentUserIsAdmin) {
                    console.log("‚öôÔ∏è Mostrando bot√≥n de administraci√≥n");
                    document.getElementById('admin-btn').style.display = 'block';
                }
                
                waitForLibraries(initMap);
            } else {
                showNotification("PIN Incorrecto", "error");
                document.getElementById('login-pin').value = '';
            }
        }

        // ====================================================================
        // FUNCIONES DE MAPA (Combinaci√≥n de SUPER7 y super5/6)
        // ====================================================================
        
        function initMap() {
            if(map) return;
            
            // Extensi√≥n Quadkey para Bing (de super5/6)
            L.TileLayer.Quadkey = L.TileLayer.extend({
                getTileUrl: function(coords) {
                    var i = coords.z, x = coords.x, y = coords.y;
                    var quadKey = "";
                    for (var j = i; j > 0; j--) {
                        var digit = 0;
                        var mask = 1 << (j - 1);
                        if ((x & mask) != 0) digit += 1;
                        if ((y & mask) != 0) digit += 2;
                        quadKey += digit;
                    }
                    return L.Util.template(this._url, { q: quadKey });
                }
            });

            map = L.map('map', { zoomControl: false, center: [9.9, -84.3], zoom: 9, maxZoom: 22, minZoom: 7 });
            L.control.zoom({ position: 'topleft' }).addTo(map);
            
            // Escala
            L.control.scale({
                position: 'bottomleft',
                imperial: false,
                maxWidth: 150
            }).addTo(map);

            // Norte (de super5/6)
            const NorthControl = L.Control.extend({
                options: { position: 'bottomleft' },
                onAdd: function() {
                    const div = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
                    div.style.background = 'none';
                    div.style.border = 'none';
                    div.style.boxShadow = 'none';
                    div.style.marginBottom = '5px';
                    div.innerHTML = `<div style="text-align:center;">
                        <div style="font-weight:900; font-size:14px; color:#333; text-shadow: 2px 2px 0px white;">N</div>
                        <svg width="30" height="40" viewBox="0 0 50 100" style="filter: drop-shadow(2px 2px 0px white);">
                            <path d="M25 0 L50 90 L25 70 L0 90 Z" fill="#333" stroke="white" stroke-width="2"/>
                        </svg>
                    </div>`;
                    return div;
                }
            });
            map.addControl(new NorthControl());

            // Capas base
            layers.google = L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', { 
                attribution: '¬© Google', maxZoom: 22, maxNativeZoom: 18 
            });
            layers.bing = new L.TileLayer.Quadkey('https://ecn.t3.tiles.virtualearth.net/tiles/a{q}.jpeg?g=1', { 
                attribution: '¬© Bing', maxZoom: 22, maxNativeZoom: 19 
            });
            layers.esri = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { 
                attribution: '¬© Esri', maxZoom: 22, maxNativeZoom: 19 
            });
            layers.osm = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', { 
                attribution: '¬© OSM', maxZoom: 22, maxNativeZoom: 19 
            });

            layers.google.addTo(map); // Default

            // Grupo para dibujos y mediciones
            drawnItems = new L.FeatureGroup();
            map.addLayer(drawnItems);
            
            // Control de dibujo (toggle)
            const DrawToggleControl = L.Control.extend({
                options: { position: 'topleft' },
                onAdd: function(map) {
                    const div = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
                    div.style.marginTop = '10px';
                    
                    const btn = L.DomUtil.create('a', 'leaflet-control-draw-toggle', div);
                    btn.href = "#";
                    btn.title = "Herramientas de Medici√≥n";
                    btn.style.width = '44px';
                    btn.style.height = '44px';
                    btn.style.display = 'flex';
                    btn.style.alignItems = 'center';
                    btn.style.justifyContent = 'center';
                    btn.style.backgroundColor = 'white';
                    btn.style.cursor = 'pointer';
                    btn.style.borderRadius = '8px';
                    btn.style.boxShadow = '0 2px 5px rgba(0,0,0,0.2)';
                    
                    btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#464646" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>`;

                    btn.onclick = (e) => {
                        e.preventDefault();
                        toggleDrawingTools();
                    };
                    return div;
                }
            });
            map.addControl(new DrawToggleControl());

            // Control GPS mejorado para m√≥viles
            const locateControl = L.Control.extend({
                options: { position: 'topleft' },
                onAdd: function() {
                    const div = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
                    div.style.marginTop = '60px';
                    
                    const btn = L.DomUtil.create('a', 'leaflet-control-gps', div);
                    btn.href = "#";
                    btn.title = "Mi ubicaci√≥n GPS";
                    btn.style.width = '44px';
                    btn.style.height = '44px';
                    btn.style.display = 'flex';
                    btn.style.alignItems = 'center';
                    btn.style.justifyContent = 'center';
                    btn.style.backgroundColor = 'white';
                    btn.style.cursor = 'pointer';
                    btn.style.borderRadius = '8px';
                    btn.style.boxShadow = '0 2px 5px rgba(0,0,0,0.2)';
                    
                    btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#464646" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="22" y1="12" x2="18" y2="12"></line><line x1="6" y1="12" x2="2" y2="12"></line><line x1="12" y1="6" x2="12" y2="2"></line><line x1="12" y1="22" x2="12" y2="18"></line></svg>`;
                    
                    btn.onclick = (e) => {
                        e.preventDefault();
                        
                        // Verificar si geolocation est√° disponible
                        if (!navigator.geolocation) {
                            showNotification("‚ùå GPS no disponible en este navegador", "error");
                            return;
                        }
                        
                        // Verificar HTTPS (excepto localhost)
                        const isSecure = window.location.protocol === 'https:' || 
                                       window.location.hostname === 'localhost' || 
                                       window.location.hostname === '127.0.0.1';
                        
                        if (!isSecure) {
                            showNotification("‚ö†Ô∏è GPS requiere HTTPS. Abre el archivo con un servidor local.", "error");
                            return;
                        }
                        
                        // Cambiar √≠cono a loading
                        btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 1 1-6.219-8.56"></path></svg>`;
                        btn.style.animation = 'spin 1s linear infinite';
                        
                        showNotification("üìç Buscando ubicaci√≥n GPS...", "success");
                        
                        // Usar geolocation directamente para mejor control de errores
                        navigator.geolocation.getCurrentPosition(
                            // Success
                            function(position) {
                                const lat = position.coords.latitude;
                                const lon = position.coords.longitude;
                                const accuracy = position.coords.accuracy;
                                
                                // Remover marcadores anteriores
                                if(userLocationMarker) map.removeLayer(userLocationMarker);
                                if(userLocationCircle) map.removeLayer(userLocationCircle);
                                
                                // Crear marcador de ubicaci√≥n
                                userLocationMarker = L.marker([lat, lon], {
                                    icon: L.divIcon({
                                        className: 'user-location-marker',
                                        html: '<div style="background-color: #3b82f6; width: 16px; height: 16px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 10px rgba(59, 130, 246, 0.8); animation: pulse 2s infinite;"></div>',
                                        iconSize: [22, 22],
                                        iconAnchor: [11, 11]
                                    })
                                }).addTo(map).bindPopup("üìç Tu ubicaci√≥n actual").openPopup();
                                
                                // C√≠rculo de precisi√≥n
                                userLocationCircle = L.circle([lat, lon], {
                                    radius: accuracy,
                                    color: '#3b82f6',
                                    weight: 1,
                                    opacity: 0.3,
                                    fillOpacity: 0.1
                                }).addTo(map);
                                
                                // Centrar mapa
                                map.setView([lat, lon], 18);
                                
                                // Registrar activaci√≥n de GPS
                                console.log('üìä GPS activado');
                                sendLog('GPS_ACTIVADO', `Lat: ${lat.toFixed(6)}, Lon: ${lon.toFixed(6)}, Precisi√≥n: ${accuracy.toFixed(2)}m`);
                                
                                // Restaurar √≠cono
                                btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="22" y1="12" x2="18" y2="12"></line><line x1="6" y1="12" x2="2" y2="12"></line><line x1="12" y1="6" x2="12" y2="2"></line><line x1="12" y1="22" x2="12" y2="18"></line></svg>`;
                                btn.style.animation = '';
                                
                                setTimeout(() => {
                                    btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#464646" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="22" y1="12" x2="18" y2="12"></line><line x1="6" y1="12" x2="2" y2="12"></line><line x1="12" y1="6" x2="12" y2="2"></line><line x1="12" y1="22" x2="12" y2="18"></line></svg>`;
                                }, 2000);
                                
                                showNotification(`‚úÖ Ubicaci√≥n encontrada (¬±${Math.round(accuracy)}m)`, "success");
                            },
                            // Error
                            function(error) {
                                // Restaurar √≠cono
                                btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#464646" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="22" y1="12" x2="18" y2="12"></line><line x1="6" y1="12" x2="2" y2="12"></line><line x1="12" y1="6" x2="12" y2="2"></line><line x1="12" y1="22" x2="12" y2="18"></line></svg>`;
                                btn.style.animation = '';
                                
                                let errorMsg = "";
                                switch(error.code) {
                                    case error.PERMISSION_DENIED:
                                        errorMsg = "‚ùå Permiso GPS denegado. Ve a Ajustes ‚Üí Sitios web ‚Üí Permisos ‚Üí Ubicaci√≥n";
                                        break;
                                    case error.POSITION_UNAVAILABLE:
                                        errorMsg = "‚ùå Ubicaci√≥n no disponible. Verifica que el GPS est√© activado";
                                        break;
                                    case error.TIMEOUT:
                                        errorMsg = "‚è±Ô∏è Tiempo agotado. Intenta al aire libre con mejor se√±al GPS";
                                        break;
                                    default:
                                        errorMsg = "‚ùå Error al obtener ubicaci√≥n GPS";
                                }
                                showNotification(errorMsg, "error");
                                console.error("GPS Error:", error);
                            },
                            // Options
                            {
                                enableHighAccuracy: true,
                                timeout: 30000, // 30 segundos (m√°s tiempo para m√≥viles)
                                maximumAge: 5000 // Aceptar ubicaci√≥n de hace 5 segundos
                            }
                        );
                    };
                    return div;
                }
            });
            
            // Agregar animaci√≥n CSS para el bot√≥n
            const style = document.createElement('style');
            style.textContent = `
                @keyframes spin {
                    from { transform: rotate(0deg); }
                    to { transform: rotate(360deg); }
                }
                @keyframes pulse {
                    0%, 100% { transform: scale(1); opacity: 1; }
                    50% { transform: scale(1.1); opacity: 0.8; }
                }
            `;
            document.head.appendChild(style);
            
            map.addControl(new locateControl());

            // Control de dibujo real
            drawControl = new L.Control.Draw({
                position: 'topleft',
                draw: {
                    polyline: { 
                        metric: true, 
                        shapeOptions: { color: '#3b82f6', weight: 3 } 
                    },
                    polygon: { 
                        showArea: true, 
                        shapeOptions: { color: '#10b981', weight: 3, fillOpacity: 0.2 } 
                    },
                    circle: false,
                    rectangle: false,
                    marker: false,
                    circlemarker: false
                },
                edit: { featureGroup: drawnItems, remove: true }
            });
            map.addControl(drawControl);

            // Eventos del mapa
            // map.on('locationfound', onLocationFound); // Ya no necesario - manejado en el bot√≥n GPS
            // map.on('locationerror', () => showNotification('‚ùå Error al obtener ubicaci√≥n GPS', 'error')); // Ya no necesario
            
            map.on(L.Draw.Event.CREATED, (e) => {
                const layer = e.layer;
                let content = '<div style="font-family: Inter, sans-serif; padding: 5px;"><strong>Medici√≥n:</strong><br>';
                
                if (e.layerType === 'polyline') {
                    const distance = calculateLength(layer.getLatLngs());
                    content += `Distancia: ${formatDistance(distance)}`;
                } else if (e.layerType === 'polygon') {
                    const area = L.GeometryUtil.geodesicArea(layer.getLatLngs()[0]);
                    content += `√Årea: ${formatArea(area)}`;
                }
                
                content += '</div>';
                layer.bindPopup(content);
                drawnItems.addLayer(layer);
                showNotification("Medici√≥n creada", "success");
            });

            map.on('zoomend', updateLabels);
            map.on('moveend', updateLabels);

            // Leyenda
            const legend = L.control({ position: 'bottomright' });
            legend.onAdd = function() {
                const div = L.DomUtil.create('div', 'leaflet-control legend');
                div.innerHTML = `
                    <h4>Estado de √Årboles</h4>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #7c3aed;"></div>
                        <span>Aprobado</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #ef4444;"></div>
                        <span>Denegado</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #f59e0b;"></div>
                        <span>Sin definir</span>
                    </div>
                `;
                return div;
            };
            legend.addTo(map);

            // Eventos de filtros
            document.getElementById('expediente-filter').addEventListener('change', (e) => filterMarkers(e.target.value));
            document.getElementById('show-labels').addEventListener('change', updateLabels);

            // Cargar datos
            loadData();
        }

        // ====================================================================
        // FUNCIONES DE DATOS Y CSV (de super5/6)
        // ====================================================================
        
        function loadData() {
            // Intentar cargar desde cach√© primero
            const cachedData = loadFromCache();
            
            if (cachedData) {
                // Tenemos datos en cach√©
                console.log("üì¶ Cargando desde cach√©...");
                updateCacheStatus('cache', cachedData.timestamp);
                processRows(cachedData.data, false, new Date(cachedData.timestamp));
                document.getElementById('loader').style.display = 'none';
                document.getElementById('map').style.display = 'block';
                document.getElementById('filter-container').style.display = 'flex';
                
                // Intentar actualizar en segundo plano si hay internet
                if (navigator.onLine) {
                    tryProxies(0, true)
                        .then(data => {
                            console.log("üîÑ Datos actualizados desde servidor");
                            saveToCache(data);
                            processRows(data, true, new Date());
                            updateCacheStatus('online', new Date());
                            showNotification("‚úÖ Datos actualizados", "success");
                            startAutoUpdate();
                        })
                        .catch(e => {
                            console.warn("No se pudo actualizar desde servidor, usando cach√©");
                            updateCacheStatus('cache', cachedData.timestamp);
                        });
                } else {
                    updateCacheStatus('offline', cachedData.timestamp);
                    showNotification("üì¶ Usando datos en cach√© (sin internet)", "info");
                }
            } else {
                // No hay cach√©, cargar desde servidor (obligatorio)
                console.log("üì° Cargando desde servidor...");
                updateCacheStatus('loading');
                tryProxies(0, false)
                    .then(data => {
                        saveToCache(data);
                        processRows(data, false, new Date());
                        document.getElementById('loader').style.display = 'none';
                        document.getElementById('map').style.display = 'block';
                        document.getElementById('filter-container').style.display = 'flex';
                        updateCacheStatus('online', new Date());
                        startAutoUpdate();
                    })
                    .catch(e => {
                        console.error("Error cargando datos:", e);
                        showNotification("‚ùå Error cargando √°rboles. Sin conexi√≥n y sin cach√©.", "error");
                        updateCacheStatus('error');
                        document.getElementById('btn-force-show').style.display = 'block';
                    });
            }
        }
        
        // ====================================================================
        // FUNCIONES DE LOCALSTORAGE (MODO OFFLINE)
        // ====================================================================
        
        function saveToCache(data) {
            try {
                const cacheObject = {
                    data: data,
                    timestamp: new Date().toISOString(),
                    version: '1.0'
                };
                localStorage.setItem('visor_acopac_cache', JSON.stringify(cacheObject));
                console.log("üíæ Datos guardados en cach√© local");
                return true;
            } catch (e) {
                console.error("Error guardando en cach√©:", e);
                // LocalStorage lleno o bloqueado
                if (e.name === 'QuotaExceededError') {
                    console.warn("‚ö†Ô∏è LocalStorage lleno, limpiando cach√© antiguo...");
                    localStorage.removeItem('visor_acopac_cache');
                    try {
                        localStorage.setItem('visor_acopac_cache', JSON.stringify(cacheObject));
                        return true;
                    } catch (e2) {
                        console.error("No se pudo guardar en cach√© incluso despu√©s de limpiar");
                        return false;
                    }
                }
                return false;
            }
        }
        
        function loadFromCache() {
            try {
                const cached = localStorage.getItem('visor_acopac_cache');
                if (!cached) return null;
                
                const cacheObject = JSON.parse(cached);
                
                // Verificar que el cach√© no sea muy antiguo (opcional: m√°ximo 7 d√≠as)
                const cacheDate = new Date(cacheObject.timestamp);
                const now = new Date();
                const daysDiff = (now - cacheDate) / (1000 * 60 * 60 * 24);
                
                if (daysDiff > 7) {
                    console.warn("‚ö†Ô∏è Cach√© muy antiguo (>7 d√≠as), ignorando...");
                    localStorage.removeItem('visor_acopac_cache');
                    return null;
                }
                
                console.log("üì¶ Cach√© encontrado:", cacheObject.timestamp);
                return cacheObject;
            } catch (e) {
                console.error("Error leyendo cach√©:", e);
                return null;
            }
        }
        
        function updateCacheStatus(status, timestamp) {
            const statusIcon = document.getElementById('cache-status-icon');
            const statusText = document.getElementById('cache-status-text');
            const lastUpdate = document.getElementById('cache-last-update');
            
            if (!statusIcon || !statusText || !lastUpdate) return;
            
            switch (status) {
                case 'online':
                    statusIcon.textContent = 'üü¢';
                    statusText.textContent = 'En l√≠nea';
                    statusText.style.color = '#10b981';
                    break;
                case 'offline':
                    statusIcon.textContent = 'üî¥';
                    statusText.textContent = 'Sin conexi√≥n';
                    statusText.style.color = '#ef4444';
                    break;
                case 'cache':
                    statusIcon.textContent = 'üì¶';
                    statusText.textContent = 'Usando cach√©';
                    statusText.style.color = '#f59e0b';
                    break;
                case 'loading':
                    statusIcon.textContent = '‚è≥';
                    statusText.textContent = 'Cargando...';
                    statusText.style.color = '#6b7280';
                    break;
                case 'error':
                    statusIcon.textContent = '‚ùå';
                    statusText.textContent = 'Error';
                    statusText.style.color = '#ef4444';
                    break;
            }
            
            if (timestamp) {
                const date = new Date(timestamp);
                const now = new Date();
                const diff = now - date;
                const minutes = Math.floor(diff / 60000);
                const hours = Math.floor(diff / 3600000);
                const days = Math.floor(diff / 86400000);
                
                let timeText;
                if (minutes < 1) {
                    timeText = 'Hace un momento';
                } else if (minutes < 60) {
                    timeText = `Hace ${minutes} min`;
                } else if (hours < 24) {
                    timeText = `Hace ${hours}h`;
                } else {
                    timeText = `Hace ${days} d√≠as`;
                }
                
                lastUpdate.textContent = `√öltima actualizaci√≥n: ${timeText}`;
            }
        }

        function tryProxies(idx, isAutoUpdate) {
            if (idx >= CORS_PROXIES.length) {
                return Promise.reject(new Error("Todos los proxies fallaron"));
            }
            
            const url = CORS_PROXIES[idx] ? 
                CORS_PROXIES[idx] + encodeURIComponent(CSV_URL + '&t=' + Date.now()) : 
                CSV_URL + '&t=' + Date.now();
            
            return fetch(url).then(r => {
                if (!r.ok) throw new Error(`HTTP ${r.status}`);
                const lastMod = r.headers.get('Last-Modified');
                return r.text().then(txt => ({ txt, lastMod }));
            }).then(({ txt, lastMod }) => {
                return new Promise((resolve, reject) => {
                    Papa.parse(txt, {
                        header: true,
                        skipEmptyLines: true,
                        complete: (res) => {
                            if (res.data && res.data.length > 0) {
                                resolve(res.data);
                            } else {
                                reject(new Error("CSV vac√≠o"));
                            }
                        },
                        error: (err) => reject(err)
                    });
                });
            }).catch(() => tryProxies(idx + 1, isAutoUpdate));
        }

        function processRows(data, isUpdate, date) {
            // Limpiar marcadores existentes
            allMarkers.forEach(m => map.removeLayer(m));
            allMarkers = [];
            expedientesSet.clear();
            
            const bounds = L.latLngBounds();
            const headers = Object.keys(data[0]);
            const norm = headers.map(h => ({ o: h, n: h.trim().toLowerCase() }));
            
            // Encontrar columnas
            let xCol = norm.find(h => h.n === 'x' || h.n === 'este' || h.n === 'coordenada x' || h.n === 'coord x')?.o;
            if (!xCol) {
                xCol = norm.find(h => (h.n.includes('x') || h.n.includes('este')) && !h.n.includes('expediente'))?.o;
            }
            
            let yCol = norm.find(h => h.n === 'y' || h.n === 'norte' || h.n === 'coordenada y' || h.n === 'coord y')?.o;
            if (!yCol) {
                yCol = norm.find(h => h.n.includes('y') || h.n.includes('norte'))?.o;
            }

            const expCol = headers.find(k => k.toLowerCase().includes('expediente'));
            const statusCol = headers.find(k => k.toLowerCase().includes('estado'));
            const idCol = headers.find(k => k.toLowerCase().includes('numero') || k.toLowerCase().includes('id'));

            data.forEach((row, i) => {
                const x = parseCRTM05(row[xCol]);
                const y = parseCRTM05(row[yCol]);
                
                if (isNaN(x) || isNaN(y)) return;
                
                try {
                    const [lon, lat] = proj4(CRTM05_DEF, 'WGS84', [x, y]);
                    if (lat < 7 || lat > 12) return;
                    
                    // Determinar estado
                    let stClass = 'status-unknown';
                    const stVal = row[statusCol] ? row[statusCol].toLowerCase() : '';
                    if (stVal.includes('aprobado') || stVal.includes('ok')) stClass = 'status-aprobado';
                    else if (stVal.includes('denegado') || stVal.includes('rechazado')) stClass = 'status-denegado';
                    
                    // Expediente
                    const expVal = (expCol && row[expCol]) ? row[expCol].trim() : "Sin Expediente";
                    if (expVal !== "Sin Expediente") expedientesSet.add(expVal);

                    // Crear marcador
                    const m = L.marker([lat, lon], {
                        icon: L.divIcon({ 
                            className: `tree-marker ${stClass}`, 
                            iconSize: [14, 14],
                            iconAnchor: [7, 7]
                        }),
                        expedienteData: expVal,
                        treeId: row[idCol] || (i+1)
                    }).addTo(map);

                    // Popup detallado
                    let popHTML = `<div class="popup-header">üå≥ √Årbol ${row[idCol] || (i+1)}</div>`;
                    popHTML += `<div class="popup-body">`;
                    
                    Object.keys(row).forEach(k => {
                        if (row[k] && k !== '_rowIndex') {
                            popHTML += `<div class="popup-row"><span>${k}</span><b>${row[k]}</b></div>`;
                        }
                    });
                    
                    popHTML += `</div>`;
                    popHTML += `<button class="btn-accept" style="width:100%; border-radius:0 0 12px 12px; margin-top:0;" onclick="startDirectNavigation(${lat},${lon},'${expVal} - ${row[idCol] || (i+1)}')">üß≠ Navegar</button>`;
                    
                    m.bindPopup(popHTML);
                    m.bindTooltip(`${row[idCol] || (i+1)}`, { 
                        permanent: true, 
                        direction: 'top', 
                        className: 'tree-label', 
                        offset: [0, -10] 
                    });
                    
                    // Registrar consulta cuando se abre el popup
                    m.on('popupopen', function() {
                        const treeId = row[idCol] || (i+1);
                        const treeInfo = `Expediente: ${expVal}, ID: ${treeId}, Especie: ${row[espCol] || 'N/A'}`;
                        console.log('üìä Consultando √°rbol:', treeInfo);
                        sendLog('CONSULTA_ARBOL', treeInfo);
                    });
                    
                    allMarkers.push(m);
                    bounds.extend([lat, lon]);
                } catch(e) {
                    console.warn("Error procesando fila:", e);
                }
            });

            // Actualizar filtro de expedientes
            const sel = document.getElementById('expediente-filter');
            const cur = sel.value;
            sel.innerHTML = '<option value="all">Todos los Expedientes</option>';
            Array.from(expedientesSet).sort().forEach(e => {
                const opt = document.createElement('option');
                opt.value = e; opt.textContent = e;
                sel.appendChild(opt);
            });
            if (cur && Array.from(sel.options).some(o => o.value === cur)) {
                sel.value = cur;
            }

            // Actualizar estad√≠sticas
            document.getElementById('filter-stats').textContent = `${allMarkers.length} √°rboles cargados`;

            // Si es carga inicial, ajustar vista
            if (allMarkers.length && !isUpdate) {
                setTimeout(() => {
                    map.invalidateSize();
                    if (allMarkers.length > 0) {
                        map.fitBounds(bounds, { padding: [50, 50] });
                    }
                }, 100);
            } else if (isUpdate) {
                filterMarkers(sel.value, false);
                showNotification(`Datos actualizados: ${allMarkers.length} √°rboles`, "success");
            }
        }

        // ====================================================================
        // FUNCIONES DE UTILIDAD
        // ====================================================================
        
        function toggleMenu() {
            const container = document.getElementById('filter-container');
            const btnIcon = document.querySelector('#menu-toggle-btn svg');
            container.classList.toggle('menu-open');
            
            if(container.classList.contains('menu-open')) {
                // Cambiar a icono X
                btnIcon.innerHTML = '<line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line>';
            } else {
                // Cambiar a icono hamburguesa
                btnIcon.innerHTML = '<line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line>';
            }
        }
        
        function toggleDrawingTools() {
            const toolbar = document.querySelector('.leaflet-draw');
            if (toolbar) {
                if (drawToolbarVisible) {
                    toolbar.style.display = 'none';
                    showNotification("Herramientas de medici√≥n ocultas", "success");
                } else {
                    toolbar.style.display = 'block';
                    showNotification("Herramientas de medici√≥n activas", "success");
                }
                drawToolbarVisible = !drawToolbarVisible;
            }
        }
        
        function clearDrawings() {
            drawnItems.clearLayers();
            showNotification("Mediciones eliminadas", "success");
        }
        
        function showNotification(msg, type) {
            const n = document.getElementById('notification');
            n.textContent = msg;
            n.className = `notification ${type}`;
            n.style.display = 'block';
            setTimeout(() => n.style.display = 'none', 3000);
        }
        
        function log(msg, type = 'info') {
            const el = document.getElementById('debug-log');
            if (!el) return;
            const timestamp = new Date().toLocaleTimeString('es-CR', { hour: '2-digit', minute: '2-digit' });
            el.innerHTML += `<div style="color: ${type==='error'?'#ef4444':'#10b981'}">[${timestamp}] ${msg}</div>`;
        }
        
        function forceShow() {
            document.getElementById('loader').style.display = 'none';
            document.getElementById('map').style.display = 'block';
            document.getElementById('filter-container').style.display = 'flex';
            if (map) setTimeout(() => map.invalidateSize(), 100);
        }
        
        function changeBaseLayer(type) {
            ['google', 'bing', 'esri', 'osm'].forEach(k => {
                if (map.hasLayer(layers[k])) map.removeLayer(layers[k]);
            });
            if (layers[type]) layers[type].addTo(map);
        }
        
        function toggleOverlay(type, isChecked) {
            if (isChecked) {
                if (!map.hasLayer(layers[type])) layers[type].addTo(map);
            } else {
                if (map.hasLayer(layers[type])) map.removeLayer(layers[type]);
            }
        }
        
        function startAutoUpdate() {
            if (autoUpdateTimer) clearInterval(autoUpdateTimer);
            autoUpdateTimer = setInterval(() => {
                tryProxies(0, true)
                    .then(data => processRows(data, true, new Date()))
                    .catch(err => console.warn("Error auto-update:", err));
            }, AUTO_UPDATE_INTERVAL);
        }
        
        function filterMarkers(val, shouldZoom = true) {
            // Registrar aplicaci√≥n de filtro
            if (val && val !== 'all') {
                console.log('üìä Filtro aplicado:', val);
                sendLog('FILTRO_APLICADO', `Expediente: ${val}`);
            }
            
            let cnt = 0;
            const b = L.latLngBounds();
            allMarkers.forEach(m => {
                const vis = (val === 'all' || m.options.expedienteData === val);
                if (vis) { 
                    if (!map.hasLayer(m)) map.addLayer(m); 
                    b.extend(m.getLatLng()); 
                    cnt++; 
                } else {
                    map.removeLayer(m);
                }
            });
            document.getElementById('filter-stats').textContent = `${cnt} √°rboles visibles`;
            
            // El marcador de ubicaci√≥n del usuario (userLocationMarker) NO est√° en allMarkers,
            // por lo que SIEMPRE permanece visible despu√©s de filtrar
            
            // Si hay zoom autom√°tico y √°rboles visibles
            if (shouldZoom && cnt > 0) {
                // Si el usuario tiene su ubicaci√≥n GPS activa, incluirla en el zoom
                if (userLocationMarker && map.hasLayer(userLocationMarker)) {
                    b.extend(userLocationMarker.getLatLng());
                }
                map.fitBounds(b, { padding: [50, 50] });
            }
            updateLabels();
        }
        
        function updateLabels() {
            if (!map) return;
            const show = document.getElementById('show-labels').checked;
            allMarkers.forEach(m => { 
                if (map.hasLayer(m) && show && map.getZoom() > 14) {
                    m.openTooltip();
                } else {
                    m.closeTooltip();
                }
            });
        }
        
        function parseCRTM05(val) {
            if (!val) return NaN;
            let str = val.toString().trim();
            if ((str.match(/\./g) || []).length > 1) str = str.replace(/\./g, '');
            else if ((str.match(/\./g) || []).length === 1 && str.split('.')[1].length === 3) str = str.replace('.', '');
            return parseFloat(str.replace(/[^0-9.-]/g, ''));
        }
        
        function calculateLength(ll) { 
            let l = 0; 
            for(let i = 0; i < ll.length - 1; i++) {
                l += ll[i].distanceTo(ll[i+1]);
            }
            return l; 
        }
        
        function formatDistance(m) { 
            return m < 1000 ? m.toFixed(2) + ' m' : (m/1000).toFixed(2) + ' km'; 
        }
        
        function formatArea(s) { 
            return s < 10000 ? s.toFixed(2) + ' m¬≤' : (s/10000).toFixed(2) + ' ha'; 
        }
        
        function clearGPXLayers() { 
            gpxLayers.forEach(l => map.removeLayer(l)); 
            gpxLayers = []; 
            showNotification('Capas GPX eliminadas', 'success'); 
        }
        
        function manualReload() {
            const btn = document.getElementById('reload-btn');
            const originalText = btn.textContent;
            btn.textContent = '‚è≥ Actualizando...';
            btn.disabled = true;
            
            updateCacheStatus('loading');
            
            // Forzar carga desde servidor (ignorar cach√©)
            tryProxies(0, false)
                .then(data => {
                    saveToCache(data);
                    processRows(data, true, new Date());
                    updateCacheStatus('online', new Date());
                    showNotification("‚úÖ Datos actualizados exitosamente", "success");
                    
                    setTimeout(() => {
                        btn.disabled = false;
                        btn.textContent = originalText;
                    }, 1000);
                })
                .catch(e => {
                    console.error("Error actualizando:", e);
                    
                    // Si falla, intentar usar cach√©
                    const cachedData = loadFromCache();
                    if (cachedData) {
                        updateCacheStatus('offline', cachedData.timestamp);
                        showNotification("‚ö†Ô∏è Sin conexi√≥n. Usando datos en cach√©.", "info");
                    } else {
                        updateCacheStatus('error');
                        showNotification("‚ùå Error de conexi√≥n y sin cach√© disponible", "error");
                    }
                    
                    setTimeout(() => {
                        btn.disabled = false;
                        btn.textContent = originalText;
                    }, 1000);
                });
        }
        
        function onLocationFound(e) {
            if(userLocationMarker) map.removeLayer(userLocationMarker);
            if(userLocationCircle) map.removeLayer(userLocationCircle);
            
            userLocationMarker = L.marker(e.latlng, {
                icon: L.divIcon({
                    className: 'user-location-marker',
                    html: '<div style="background-color: #3b82f6; width: 16px; height: 16px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 10px rgba(59, 130, 246, 0.8);"></div>',
                    iconSize: [22, 22],
                    iconAnchor: [11, 11]
                })
            }).addTo(map).bindPopup("Tu ubicaci√≥n").openPopup();
            
            userLocationCircle = L.circle(e.latlng, {
                radius: e.accuracy,
                color: '#3b82f6',
                weight: 1,
                opacity: 0.3,
                fillOpacity: 0.1
            }).addTo(map);
            
            showNotification(`GPS: Precisi√≥n ¬±${Math.round(e.accuracy)}m`, "success");
        }

        // ====================================================================
        // FUNCIONES DE NAVEGACI√ìN (de SUPER7)
        // ====================================================================
        
        function openNavSetup() {
            const s = document.getElementById('nav-expediente');
            s.innerHTML = '<option value="">Seleccione expediente...</option>';
            Array.from(expedientesSet).sort().forEach(e => {
                s.innerHTML += `<option value="${e}">${e}</option>`;
            });
            document.getElementById('nav-setup-modal').style.display = 'flex';
            if(document.getElementById('filter-container').classList.contains('menu-open')) {
                toggleMenu();
            }
        }
        
        function updateNavTrees() {
            const exp = document.getElementById('nav-expediente').value;
            const s = document.getElementById('nav-tree');
            s.innerHTML = '<option value="">Seleccione √°rbol...</option>';
            
            allMarkers
                .filter(m => m.options.expedienteData === exp)
                .forEach(m => {
                    s.innerHTML += `<option value="${m.getLatLng().lat},${m.getLatLng().lng}">√Årbol ${m.options.treeId}</option>`;
                });
        }
        
        function startDirectNavigation(lat, lng, label) {
            // Registrar inicio de navegaci√≥n
            console.log('üìä Navegaci√≥n iniciada:', label);
            sendLog('NAVEGACION_INICIADA', `Destino: ${label}, Lat: ${lat}, Lon: ${lng}`);
            
            targetLatLng = L.latLng(lat, lng);
            document.getElementById('nav-target-info').textContent = label;
            map.closePopup();
            closeNavSetup();
            document.getElementById('nav-dashboard').style.display = 'flex';
            
            // Reset GPS buffer
            gpsReadings = [];
            lastGoodPosition = null;
            gpsQuality = 'searching';
            updateGPSQualityIndicator();
            
            // Iniciar sensor de orientaci√≥n del dispositivo (sistema avanzado)
            startDeviceOrientation();
            
            // Iniciar loop de sensor fusion
            requestAnimationFrame(sensorFusionLoop);
            
            if (navigator.geolocation) {
                // Usar watchPosition con configuraci√≥n optimizada para alta precisi√≥n
                navWatchId = navigator.geolocation.watchPosition(
                    processGPSReading,
                    handleGPSError,
                    {
                        enableHighAccuracy: true,  // Usar GPS real, no WiFi/Cell
                        maximumAge: GPS_MAX_AGE,   // No usar lecturas muy antiguas
                        timeout: 10000             // Dar m√°s tiempo para obtener buena se√±al
                    }
                );
                
                showNotification("üõ∞Ô∏è Conectando GPS de alta precisi√≥n...", "success");
            } else {
                showNotification("‚ùå GPS no disponible", "error");
            }
        }
        
        // Procesar lectura GPS con filtrado
        function processGPSReading(pos) {
            const accuracy = pos.coords.accuracy;
            const timestamp = pos.timestamp;
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            const altitude = pos.coords.altitude;
            const speed = pos.coords.speed;
            const heading = pos.coords.heading;
            
            // Crear objeto de lectura
            const reading = {
                lat,
                lng,
                accuracy,
                timestamp,
                altitude,
                speed,
                heading
            };
            
            // Determinar calidad de la lectura
            let quality = 'poor';
            if (accuracy <= 5) {
                quality = 'excellent';
            } else if (accuracy <= 10) {
                quality = 'good';
            } else if (accuracy <= 20) {
                quality = 'fair';
            }
            
            // Solo agregar lecturas con precisi√≥n aceptable al buffer
            if (accuracy <= 50) { // M√°ximo 50m de error
                gpsReadings.push(reading);
                
                // Mantener solo las √∫ltimas N lecturas
                while (gpsReadings.length > GPS_BUFFER_SIZE) {
                    gpsReadings.shift();
                }
                
                // Si es una buena lectura, guardarla como √∫ltima buena posici√≥n
                if (accuracy <= GPS_ACCURACY_THRESHOLD) {
                    lastGoodPosition = reading;
                }
            }
            
            // Actualizar indicador de calidad GPS
            gpsQuality = quality;
            updateGPSQualityIndicator();
            
            // Calcular posici√≥n filtrada
            const filteredPos = calculateFilteredPosition();
            
            if (filteredPos) {
                updateNavigationDisplay(filteredPos);
            }
            
            // Log para debug
            console.log(`üìç GPS: ¬±${accuracy.toFixed(1)}m (${quality}) - Buffer: ${gpsReadings.length}/${GPS_BUFFER_SIZE}`);
        }
        
        // Calcular posici√≥n filtrada usando el buffer de lecturas
        function calculateFilteredPosition() {
            if (gpsReadings.length === 0) return null;
            
            // Si tenemos pocas lecturas, usar la mejor disponible
            if (gpsReadings.length < 3) {
                // Encontrar la lectura con mejor precisi√≥n
                let best = gpsReadings[0];
                for (const r of gpsReadings) {
                    if (r.accuracy < best.accuracy) best = r;
                }
                return best;
            }
            
            // Calcular promedio ponderado por precisi√≥n (inverso del error)
            let weightSum = 0;
            let latSum = 0;
            let lngSum = 0;
            let accuracySum = 0;
            
            for (const reading of gpsReadings) {
                // Peso inversamente proporcional al error^2
                const weight = 1 / (reading.accuracy * reading.accuracy);
                weightSum += weight;
                latSum += reading.lat * weight;
                lngSum += reading.lng * weight;
                accuracySum += reading.accuracy * weight;
            }
            
            return {
                lat: latSum / weightSum,
                lng: lngSum / weightSum,
                accuracy: accuracySum / weightSum,
                timestamp: Date.now()
            };
        }
        
        // Actualizar display de navegaci√≥n con posici√≥n filtrada
        function updateNavigationDisplay(pos) {
            const user = L.latLng(pos.lat, pos.lng);
            const dist = user.distanceTo(targetLatLng);
            
            // Actualizar distancia
            document.getElementById('nav-dist').textContent = Math.round(dist);
            
            // Mostrar precisi√≥n con color seg√∫n calidad
            const accElement = document.getElementById('nav-accuracy');
            accElement.textContent = `¬±${Math.round(pos.accuracy)}m`;
            
            if (pos.accuracy <= 5) {
                accElement.style.color = '#10b981'; // Verde
            } else if (pos.accuracy <= 10) {
                accElement.style.color = '#22c55e'; // Verde claro
            } else if (pos.accuracy <= 20) {
                accElement.style.color = '#f59e0b'; // Amarillo
            } else {
                accElement.style.color = '#ef4444'; // Rojo
            }
            
            // Calcular rumbo hacia el objetivo (bearing)
            const lat1 = pos.lat * Math.PI / 180;
            const lat2 = targetLatLng.lat * Math.PI / 180;
            const dLng = (targetLatLng.lng - pos.lng) * Math.PI / 180;
            
            const y = Math.sin(dLng) * Math.cos(lat2);
            const x = Math.cos(lat1) * Math.sin(lat2) - 
                     Math.sin(lat1) * Math.cos(lat2) * Math.cos(dLng);
            targetBearing = (Math.atan2(y, x) * 180 / Math.PI + 360) % 360;
            
            document.getElementById('nav-bearing').textContent = Math.round(targetBearing) + '¬∞';
            
            // Mostrar orientaci√≥n del dispositivo
            document.getElementById('nav-device-heading').textContent = Math.round(deviceHeading) + '¬∞';
            
            // Calcular el √°ngulo de rotaci√≥n con normalizaci√≥n correcta
            let rotationAngle = targetBearing - deviceHeading;
            
            // Normalizar el √°ngulo al rango [-180, 180]
            while (rotationAngle > 180) rotationAngle -= 360;
            while (rotationAngle < -180) rotationAngle += 360;
            
            document.getElementById('nav-arrow-container').style.transform = `rotate(${rotationAngle}deg)`;
            
            // Actualizar indicadores de confiabilidad
            updateConfidenceIndicator();
            
            // Actualizar contador de buffer GPS
            const bufferEl = document.getElementById('nav-gps-buffer');
            if (bufferEl) {
                bufferEl.textContent = `${gpsReadings.length}/${GPS_BUFFER_SIZE}`;
            }
            
            // Alerta de proximidad
            if (dist < 5) {
                showNotification("üéØ ¬°Llegaste al destino!", "success");
                // Vibrar si est√° disponible
                if (navigator.vibrate) {
                    navigator.vibrate([200, 100, 200]);
                }
            } else if (dist < 10) {
                document.getElementById('nav-dist').style.color = '#10b981';
            } else {
                document.getElementById('nav-dist').style.color = '#10b981'; // Reset
            }
        }
        
        // Manejar errores de GPS
        function handleGPSError(error) {
            console.error("Error GPS:", error);
            
            let message = "";
            switch (error.code) {
                case error.PERMISSION_DENIED:
                    message = "‚ùå Permiso GPS denegado";
                    gpsQuality = 'error';
                    break;
                case error.POSITION_UNAVAILABLE:
                    message = "‚ö†Ô∏è Se√±al GPS no disponible";
                    gpsQuality = 'searching';
                    // Usar √∫ltima buena posici√≥n si existe
                    if (lastGoodPosition) {
                        showNotification("üìç Usando √∫ltima ubicaci√≥n conocida", "info");
                        updateNavigationDisplay(lastGoodPosition);
                    }
                    break;
                case error.TIMEOUT:
                    message = "‚è±Ô∏è Tiempo agotado buscando GPS";
                    gpsQuality = 'searching';
                    break;
                default:
                    message = "‚ùå Error GPS desconocido";
                    gpsQuality = 'error';
            }
            
            updateGPSQualityIndicator();
            showNotification(message, "error");
        }
        
        // Actualizar indicador visual de calidad GPS
        function updateGPSQualityIndicator() {
            const indicator = document.getElementById('nav-gps-quality');
            const qualityText = document.getElementById('nav-gps-quality-text');
            
            if (!indicator) return;
            
            let color, bars, text;
            
            switch (gpsQuality) {
                case 'excellent':
                    color = '#10b981';
                    bars = 4;
                    text = 'Excelente';
                    break;
                case 'good':
                    color = '#22c55e';
                    bars = 3;
                    text = 'Buena';
                    break;
                case 'fair':
                    color = '#f59e0b';
                    bars = 2;
                    text = 'Regular';
                    break;
                case 'poor':
                    color = '#f97316';
                    bars = 1;
                    text = 'D√©bil';
                    break;
                case 'searching':
                    color = '#6b7280';
                    bars = 0;
                    text = 'Buscando...';
                    break;
                case 'error':
                    color = '#ef4444';
                    bars = 0;
                    text = 'Error';
                    break;
                default:
                    color = '#6b7280';
                    bars = 0;
                    text = '--';
            }
            
            // Actualizar barras de se√±al
            indicator.innerHTML = '';
            for (let i = 0; i < 4; i++) {
                const bar = document.createElement('div');
                bar.style.cssText = `
                    width: 4px;
                    height: ${6 + i * 4}px;
                    background: ${i < bars ? color : '#374151'};
                    border-radius: 1px;
                    transition: all 0.3s;
                `;
                indicator.appendChild(bar);
            }
            
            if (qualityText) {
                qualityText.textContent = text;
                qualityText.style.color = color;
            }
        }
        
        // Funci√≥n legacy mantenida para compatibilidad
        function updateNavigation(pos) {
            processGPSReading(pos);
        }
        
        function startNavigation() {
            const val = document.getElementById('nav-tree').value;
            if (!val) {
                showNotification("Seleccione un √°rbol", "error");
                return;
            }
            
            const [lat, lng] = val.split(',').map(Number);
            const exp = document.getElementById('nav-expediente').value;
            const treeId = document.getElementById('nav-tree').selectedOptions[0]?.text || "Destino";
            
            startDirectNavigation(lat, lng, `${exp} - ${treeId}`);
            closeNavSetup();
        }
        
        function updateNavigation(pos) {
            const user = L.latLng(pos.coords.latitude, pos.coords.longitude);
            const dist = user.distanceTo(targetLatLng);
            
            document.getElementById('nav-dist').textContent = Math.round(dist);
            document.getElementById('nav-accuracy').textContent = `¬±${Math.round(pos.coords.accuracy)}m`;
            
            // Calcular rumbo hacia el objetivo (bearing)
            const lat1 = user.lat * Math.PI / 180;
            const lat2 = targetLatLng.lat * Math.PI / 180;
            const dLng = (targetLatLng.lng - user.lng) * Math.PI / 180;
            
            const y = Math.sin(dLng) * Math.cos(lat2);
            const x = Math.cos(lat1) * Math.sin(lat2) - 
                     Math.sin(lat1) * Math.cos(lat2) * Math.cos(dLng);
            targetBearing = (Math.atan2(y, x) * 180 / Math.PI + 360) % 360;
            
            document.getElementById('nav-bearing').textContent = Math.round(targetBearing) + '¬∞';
            
            // Mostrar orientaci√≥n del dispositivo (debug)
            document.getElementById('nav-device-heading').textContent = Math.round(deviceHeading) + '¬∞';
            
            // Calcular el √°ngulo de rotaci√≥n con normalizaci√≥n correcta
            // Esto maneja correctamente el wraparound de 0-360 grados
            let rotationAngle = targetBearing - deviceHeading;
            
            // Normalizar el √°ngulo al rango [-180, 180]
            // Esto asegura que siempre tomamos el camino m√°s corto
            while (rotationAngle > 180) rotationAngle -= 360;
            while (rotationAngle < -180) rotationAngle += 360;
            
            document.getElementById('nav-arrow-container').style.transform = `rotate(${rotationAngle}deg)`;
            
            // Actualizar indicador de confiabilidad
            updateConfidenceIndicator();
        }
        
        
        // ====================================================================
        // SISTEMA AVANZADO DE ORIENTACI√ìN Y SENSORES
        // ====================================================================
        
        // Inicializar todos los sensores disponibles
        async function initAdvancedSensors() {
            console.log('üß≠ Inicializando sensores avanzados...');
            
            // 1. Intentar Generic Sensor API (m√°s precisa, Chrome 67+)
            await initGenericSensors();
            
            // 2. Fallback a DeviceOrientation API
            initDeviceOrientationSensors();
            
            // 3. Iniciar loop de actualizaci√≥n de sensores
            requestAnimationFrame(sensorFusionLoop);
            
            logSensorStatus();
        }
        
        // Inicializar Generic Sensor API (si est√° disponible)
        async function initGenericSensors() {
            // AbsoluteOrientationSensor - El m√°s preciso (fusiona todos los sensores)
            if ('AbsoluteOrientationSensor' in window) {
                try {
                    const permissionStatus = await navigator.permissions.query({ name: 'accelerometer' });
                    if (permissionStatus.state === 'granted' || permissionStatus.state === 'prompt') {
                        absoluteOrientationSensor = new AbsoluteOrientationSensor({ frequency: 60, referenceFrame: 'device' });
                        absoluteOrientationSensor.addEventListener('reading', handleAbsoluteOrientation);
                        absoluteOrientationSensor.addEventListener('error', (e) => {
                            console.warn('AbsoluteOrientationSensor error:', e.error.name);
                            sensorsAvailable.absoluteOrientation = false;
                        });
                        absoluteOrientationSensor.start();
                        sensorsAvailable.absoluteOrientation = true;
                        console.log('‚úÖ AbsoluteOrientationSensor activo');
                    }
                } catch (e) {
                    console.log('AbsoluteOrientationSensor no disponible:', e.message);
                }
            }
            
            // Accelerometer
            if ('Accelerometer' in window) {
                try {
                    accelerometer = new Accelerometer({ frequency: 60 });
                    accelerometer.addEventListener('reading', () => {
                        accelerometerData = {
                            x: accelerometer.x,
                            y: accelerometer.y,
                            z: accelerometer.z
                        };
                    });
                    accelerometer.start();
                    sensorsAvailable.accelerometer = true;
                    console.log('‚úÖ Accelerometer activo');
                } catch (e) {
                    console.log('Accelerometer no disponible:', e.message);
                }
            }
            
            // Gyroscope
            if ('Gyroscope' in window) {
                try {
                    gyroscope = new Gyroscope({ frequency: 60 });
                    gyroscope.addEventListener('reading', () => {
                        gyroscopeData = {
                            alpha: gyroscope.x,
                            beta: gyroscope.y,
                            gamma: gyroscope.z
                        };
                    });
                    gyroscope.start();
                    sensorsAvailable.gyroscope = true;
                    console.log('‚úÖ Gyroscope activo');
                } catch (e) {
                    console.log('Gyroscope no disponible:', e.message);
                }
            }
            
            // Magnetometer
            if ('Magnetometer' in window) {
                try {
                    magnetometer = new Magnetometer({ frequency: 60 });
                    magnetometer.addEventListener('reading', handleMagnetometerReading);
                    magnetometer.start();
                    sensorsAvailable.magnetometer = true;
                    console.log('‚úÖ Magnetometer activo');
                } catch (e) {
                    console.log('Magnetometer no disponible:', e.message);
                }
            }
        }
        
        // Manejar lectura del AbsoluteOrientationSensor
        function handleAbsoluteOrientation() {
            if (!absoluteOrientationSensor) return;
            
            // Convertir quaternion a √°ngulos de Euler
            const q = absoluteOrientationSensor.quaternion;
            if (q) {
                // Extraer heading (yaw) del quaternion
                const heading = quaternionToHeading(q[0], q[1], q[2], q[3]);
                
                // Este sensor ya tiene fusion, alta confianza
                rawHeading = heading;
                orientationConfidence = 95;
                magnetometerCalibrated = true;
            }
        }
        
        // Convertir quaternion a heading (azimuth)
        function quaternionToHeading(x, y, z, w) {
            // Calcular yaw (heading) desde quaternion
            const siny_cosp = 2 * (w * z + x * y);
            const cosy_cosp = 1 - 2 * (y * y + z * z);
            let heading = Math.atan2(siny_cosp, cosy_cosp) * (180 / Math.PI);
            
            // Normalizar a 0-360
            heading = (360 - heading) % 360;
            return heading;
        }
        
        // Manejar lectura del magnet√≥metro
        function handleMagnetometerReading() {
            if (!magnetometer) return;
            
            const mx = magnetometer.x;
            const my = magnetometer.y;
            const mz = magnetometer.z;
            
            // Calcular magnitud del campo magn√©tico
            const magnitude = Math.sqrt(mx * mx + my * my + mz * mz);
            
            // Detectar si hay interferencia magn√©tica (campo muy fuerte o muy d√©bil)
            // El campo magn√©tico terrestre normal es ~25-65 ŒºT
            if (magnitude < 20 || magnitude > 80) {
                compassCalibrationNeeded = true;
                orientationConfidence = Math.max(0, orientationConfidence - 10);
            } else {
                compassCalibrationNeeded = false;
                magnetometerCalibrated = true;
            }
            
            // Calcular heading desde magnet√≥metro (compensando con aceler√≥metro)
            if (sensorsAvailable.accelerometer) {
                const heading = calculateTiltCompensatedHeading(
                    mx, my, mz,
                    accelerometerData.x, accelerometerData.y, accelerometerData.z
                );
                
                if (!sensorsAvailable.absoluteOrientation) {
                    rawHeading = heading;
                    orientationConfidence = compassCalibrationNeeded ? 40 : 75;
                }
            }
        }
        
        // Calcular heading compensado por inclinaci√≥n
        function calculateTiltCompensatedHeading(mx, my, mz, ax, ay, az) {
            // Normalizar aceler√≥metro
            const aMag = Math.sqrt(ax * ax + ay * ay + az * az);
            const axn = ax / aMag;
            const ayn = ay / aMag;
            const azn = az / aMag;
            
            // Calcular pitch y roll
            const pitch = Math.asin(-axn);
            const roll = Math.atan2(ayn, azn);
            
            // Compensar magnet√≥metro por inclinaci√≥n
            const mxh = mx * Math.cos(pitch) + mz * Math.sin(pitch);
            const myh = mx * Math.sin(roll) * Math.sin(pitch) + my * Math.cos(roll) - mz * Math.sin(roll) * Math.cos(pitch);
            
            // Calcular heading
            let heading = Math.atan2(-myh, mxh) * (180 / Math.PI);
            
            // Normalizar a 0-360
            heading = (heading + 360) % 360;
            
            return heading;
        }
        
        // Inicializar DeviceOrientation API (fallback)
        function initDeviceOrientationSensors() {
            if (typeof DeviceOrientationEvent !== 'undefined') {
                // iOS 13+ requiere permiso expl√≠cito
                if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                    DeviceOrientationEvent.requestPermission()
                        .then(response => {
                            if (response === 'granted') {
                                setupDeviceOrientationListeners();
                            } else {
                                console.warn('Permiso de orientaci√≥n denegado');
                                showNotification('‚ö†Ô∏è Permiso de br√∫jula denegado', 'error');
                            }
                        })
                        .catch(err => {
                            console.error('Error solicitando permiso:', err);
                            // Intentar sin permiso (puede funcionar en algunos casos)
                            setupDeviceOrientationListeners();
                        });
                } else {
                    // Android y otros navegadores
                    setupDeviceOrientationListeners();
                }
            }
        }
        
        function setupDeviceOrientationListeners() {
            // Priorizar deviceorientationabsolute (m√°s preciso)
            window.addEventListener('deviceorientationabsolute', handleDeviceOrientation, true);
            window.addEventListener('deviceorientation', handleDeviceOrientationFallback, true);
            
            // Tambi√©n escuchar movimiento del dispositivo para detectar si est√° quieto
            window.addEventListener('devicemotion', handleDeviceMotion, true);
            
            sensorsAvailable.deviceOrientation = true;
            orientationSupported = true;
            console.log('‚úÖ DeviceOrientation listeners activos');
        }
        
        // Manejar deviceorientationabsolute (preferido)
        function handleDeviceOrientation(event) {
            if (sensorsAvailable.absoluteOrientation) return; // Preferir Generic Sensor API
            
            let heading = 0;
            
            if (event.webkitCompassHeading !== undefined) {
                // iOS - webkitCompassHeading ya es el heading correcto
                heading = event.webkitCompassHeading;
                orientationConfidence = event.webkitCompassAccuracy ? 
                    Math.max(0, 100 - event.webkitCompassAccuracy) : 70;
            } else if (event.alpha !== null && event.absolute === true) {
                // Android con orientaci√≥n absoluta
                // alpha = 0 cuando apunta al norte magn√©tico
                heading = (360 - event.alpha) % 360;
                orientationConfidence = 70;
            }
            
            rawHeading = heading;
            magnetometerCalibrated = true;
            lastOrientationUpdate = Date.now();
        }
        
        // Fallback para deviceorientation no absoluta
        function handleDeviceOrientationFallback(event) {
            if (sensorsAvailable.absoluteOrientation) return;
            if (lastOrientationUpdate > Date.now() - 100) return; // Ya tenemos datos absolutos recientes
            
            if (event.alpha !== null) {
                // Orientaci√≥n relativa - menos confiable
                rawHeading = (360 - event.alpha) % 360;
                orientationConfidence = 40; // Baja confianza
                magnetometerCalibrated = false;
            }
        }
        
        // Manejar devicemotion para detectar estabilidad
        function handleDeviceMotion(event) {
            if (!event.acceleration) return;
            
            const acc = event.acceleration;
            const movement = Math.sqrt(
                (acc.x || 0) ** 2 + 
                (acc.y || 0) ** 2 + 
                (acc.z || 0) ** 2
            );
            
            // Si el dispositivo est√° muy quieto, la br√∫jula es m√°s confiable
            if (movement < 0.5) {
                orientationConfidence = Math.min(100, orientationConfidence + 2);
            } else if (movement > 3) {
                // Mucho movimiento reduce la confianza
                orientationConfidence = Math.max(20, orientationConfidence - 5);
            }
        }
        
        // Loop principal de sensor fusion
        function sensorFusionLoop() {
            // Aplicar filtro de paso bajo al heading
            filteredHeading = applyLowPassFilter(rawHeading, filteredHeading, HEADING_FILTER_ALPHA);
            
            // Agregar al historial para suavizado adicional
            headingHistory.push(filteredHeading);
            if (headingHistory.length > HEADING_BUFFER_SIZE) {
                headingHistory.shift();
            }
            
            // Calcular heading final con promedio circular
            deviceHeading = circularMean(headingHistory);
            
            // Continuar el loop si hay navegaci√≥n activa
            if (document.getElementById('nav-dashboard').style.display === 'flex') {
                requestAnimationFrame(sensorFusionLoop);
            }
        }
        
        // Filtro de paso bajo para suavizar lecturas
        function applyLowPassFilter(newValue, oldValue, alpha) {
            // Manejar el cruce de 0/360 grados
            let diff = newValue - oldValue;
            if (diff > 180) diff -= 360;
            if (diff < -180) diff += 360;
            
            return (oldValue + alpha * diff + 360) % 360;
        }
        
        // Calcular promedio circular (para √°ngulos)
        function circularMean(angles) {
            if (angles.length === 0) return 0;
            
            let sinSum = 0;
            let cosSum = 0;
            
            for (const angle of angles) {
                const rad = angle * Math.PI / 180;
                sinSum += Math.sin(rad);
                cosSum += Math.cos(rad);
            }
            
            let mean = Math.atan2(sinSum / angles.length, cosSum / angles.length) * 180 / Math.PI;
            return (mean + 360) % 360;
        }
        
        // Actualizar indicador visual de confiabilidad
        function updateConfidenceIndicator() {
            const indicator = document.getElementById('nav-confidence-indicator');
            const confidenceText = document.getElementById('nav-confidence-text');
            const calibrationWarning = document.getElementById('nav-calibration-warning');
            
            if (!indicator) return;
            
            let color, text, reliable;
            
            if (orientationConfidence >= 80) {
                color = '#10b981'; // Verde
                text = 'ALTA';
                reliable = true;
            } else if (orientationConfidence >= 50) {
                color = '#f59e0b'; // Amarillo
                text = 'MEDIA';
                reliable = true;
            } else if (orientationConfidence >= 30) {
                color = '#f97316'; // Naranja
                text = 'BAJA';
                reliable = false;
            } else {
                color = '#ef4444'; // Rojo
                text = 'MUY BAJA';
                reliable = false;
            }
            
            indicator.style.background = color;
            indicator.style.boxShadow = `0 0 ${reliable ? '15' : '8'}px ${color}`;
            
            if (confidenceText) {
                confidenceText.textContent = `${text} (${Math.round(orientationConfidence)}%)`;
                confidenceText.style.color = color;
            }
            
            // Mostrar advertencia de calibraci√≥n si es necesario
            if (calibrationWarning) {
                if (compassCalibrationNeeded) {
                    calibrationWarning.style.display = 'block';
                    calibrationWarning.textContent = '‚ö†Ô∏è Mueve el tel√©fono en forma de 8 para calibrar';
                } else if (!magnetometerCalibrated && orientationConfidence < 50) {
                    calibrationWarning.style.display = 'block';
                    calibrationWarning.textContent = '‚ö†Ô∏è Esperando calibraci√≥n de br√∫jula...';
                } else {
                    calibrationWarning.style.display = 'none';
                }
            }
            
            // Actualizar estilo de la flecha seg√∫n confiabilidad
            const arrowContainer = document.getElementById('nav-arrow-container');
            if (arrowContainer) {
                if (reliable) {
                    arrowContainer.style.borderColor = color;
                    arrowContainer.style.opacity = '1';
                } else {
                    arrowContainer.style.borderColor = '#475569';
                    arrowContainer.style.opacity = '0.6';
                }
            }
        }
        
        // Log del estado de sensores
        function logSensorStatus() {
            console.log('üìä Estado de sensores:');
            console.log('  - AbsoluteOrientation:', sensorsAvailable.absoluteOrientation ? '‚úÖ' : '‚ùå');
            console.log('  - Accelerometer:', sensorsAvailable.accelerometer ? '‚úÖ' : '‚ùå');
            console.log('  - Gyroscope:', sensorsAvailable.gyroscope ? '‚úÖ' : '‚ùå');
            console.log('  - Magnetometer:', sensorsAvailable.magnetometer ? '‚úÖ' : '‚ùå');
            console.log('  - DeviceOrientation:', sensorsAvailable.deviceOrientation ? '‚úÖ' : '‚ùå');
        }
        
        // Funci√≥n legacy mantenida para compatibilidad
        function startDeviceOrientation() {
            initAdvancedSensors();
        }
        
        function handleOrientation(event) {
            // Redirigir a nueva funci√≥n
            handleDeviceOrientation(event);
        }
        
        function handleOrientationFallback(event) {
            // Redirigir a nueva funci√≥n
            handleDeviceOrientationFallback(event);
        }
        
        function stopDeviceOrientation() {
            // Detener Generic Sensor API
            if (absoluteOrientationSensor) {
                absoluteOrientationSensor.stop();
                absoluteOrientationSensor = null;
            }
            if (accelerometer) {
                accelerometer.stop();
                accelerometer = null;
            }
            if (gyroscope) {
                gyroscope.stop();
                gyroscope = null;
            }
            if (magnetometer) {
                magnetometer.stop();
                magnetometer = null;
            }
            
            // Detener DeviceOrientation listeners
            window.removeEventListener('deviceorientationabsolute', handleDeviceOrientation, true);
            window.removeEventListener('deviceorientation', handleDeviceOrientationFallback, true);
            window.removeEventListener('devicemotion', handleDeviceMotion, true);
            
            // Reset variables
            deviceHeading = 0;
            filteredHeading = 0;
            rawHeading = 0;
            headingHistory = [];
            orientationConfidence = 0;
            orientationSupported = false;
            magnetometerCalibrated = false;
            
            // Reset sensores disponibles
            sensorsAvailable = {
                absoluteOrientation: false,
                accelerometer: false,
                gyroscope: false,
                magnetometer: false,
                deviceOrientation: false
            };
        }
        
        function stopNavigation() {
            if (navWatchId && navigator.geolocation) {
                navigator.geolocation.clearWatch(navWatchId);
            }
            stopDeviceOrientation();
            document.getElementById('nav-dashboard').style.display = 'none';
            showNotification("Navegaci√≥n detenida", "success");
        }

        // ====================================================================
        // FUNCIONES DE COORDENADAS
        // ====================================================================
        
        function showCoordModal() { 
            document.getElementById('coord-modal').style.display = 'flex'; 
            document.getElementById('coord-x').focus(); 
        }
        
        function closeCoordModal() { 
            document.getElementById('coord-modal').style.display = 'none'; 
        }
        
        function closeNavSetup() { 
            document.getElementById('nav-setup-modal').style.display = 'none'; 
        }
        
        function processCoordSearch() {
            const x = parseCRTM05(document.getElementById('coord-x').value);
            const y = parseCRTM05(document.getElementById('coord-y').value);
            
            if(isNaN(x) || isNaN(y)) {
                showNotification("Coordenadas inv√°lidas", "error");
                return;
            }
            
            try {
                const [lon, lat] = proj4(CRTM05_DEF, 'WGS84', [x, y]);
                
                if (lat < 7 || lat > 12 || lon < -86 || lon > -82) {
                    showNotification("Coordenadas fuera de Costa Rica", "error");
                    return;
                }

                const newMarker = L.marker([lat, lon], {
                    icon: L.divIcon({
                        className: 'custom-search-marker',
                        html: '<div style="background-color: #3b82f6; width: 20px; height: 20px; border-radius: 50%; border: 4px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.5);"></div>',
                        iconSize: [24, 24],
                        iconAnchor: [12, 12]
                    })
                }).addTo(map);

                const popupContent = `<div style="font-family: Inter, sans-serif; padding: 5px;">
                    <b>üìç Punto CRTM05</b><br>
                    X: ${x.toLocaleString('es-CR')}<br>
                    Y: ${y.toLocaleString('es-CR')}<br>
                    Lat: ${lat.toFixed(6)}<br>
                    Lon: ${lon.toFixed(6)}
                </div>
                <button class="btn-accept" style="width:100%; border-radius:0 0 12px 12px; margin-top:8px; padding:10px;" onclick="startDirectNavigation(${lat},${lon},'Coordenada: X=${x.toLocaleString('es-CR')} Y=${y.toLocaleString('es-CR')}')">üß≠ Navegar</button>`;
                
                newMarker.bindPopup(popupContent);
                drawnItems.addLayer(newMarker);
                
                map.setView([lat, lon], 18);
                newMarker.openPopup();
                
                closeCoordModal();
                if(document.getElementById('filter-container').classList.contains('menu-open')) {
                    toggleMenu();
                }
                showNotification('üìç Coordenada agregada al mapa', 'success');

            } catch (e) { 
                showNotification("Error en conversi√≥n de coordenadas", "error");
            }
        }
        
        function enableMapPick() {
            closeCoordModal();
            showNotification("Toque en el mapa para seleccionar coordenadas", "success");
            
            const clickHandler = (e) => {
                map.off('click', clickHandler);
                const [x, y] = proj4('WGS84', CRTM05_DEF, [e.latlng.lng, e.latlng.lat]);
                document.getElementById('coord-x').value = x.toFixed(2);
                document.getElementById('coord-y').value = y.toFixed(2);
                showCoordModal();
            };
            
            map.once('click', clickHandler);
        }

        // ====================================================================
        // FUNCIONES DE GPX/KML (de super5/6)
        // ====================================================================
        
        document.getElementById('gpx-input').addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            if (files.length === 0) return;
            
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    try {
                        let geoJson;
                        const parser = new DOMParser();
                        const xmlDoc = parser.parseFromString(ev.target.result, 'text/xml');
                        
                        if (file.name.endsWith('.gpx')) {
                            geoJson = toGeoJSON.gpx(xmlDoc);
                        } else if (file.name.endsWith('.kml')) {
                            geoJson = toGeoJSON.kml(xmlDoc);
                        } else {
                            showNotification("Formato no soportado: " + file.name, "error");
                            return;
                        }
                        
                        const layer = L.geoJSON(geoJson, {
                            style: function(feature) {
                                return {
                                    color: '#ef4444',
                                    weight: 3,
                                    opacity: 0.8,
                                    fillColor: '#f87171',
                                    fillOpacity: 0.2
                                };
                            },
                            pointToLayer: function(feature, latlng) {
                                return L.circleMarker(latlng, {
                                    radius: 6,
                                    fillColor: "#ef4444",
                                    color: "#fff",
                                    weight: 2,
                                    opacity: 1,
                                    fillOpacity: 0.8
                                });
                            },
                            onEachFeature: function(feature, layer) {
                                if (feature.properties && feature.properties.name) {
                                    layer.bindPopup(`<b>${feature.properties.name}</b>`);
                                }
                            }
                        }).addTo(map);
                        
                        gpxLayers.push(layer);
                        map.fitBounds(layer.getBounds());
                        showNotification(`Archivo ${file.name} cargado`, "success");
                        
                    } catch (error) {
                        console.error("Error procesando archivo:", error);
                        showNotification(`Error cargando ${file.name}`, "error");
                    }
                };
                reader.readAsText(file);
            });
            
            // Reset input
            e.target.value = '';
        });

        // ====================================================================
        // FUNCIONES DE AYUDA
        // ====================================================================
        
        function showHelp() { 
            document.getElementById('help-panel').style.display = 'block'; 
            document.getElementById('help-overlay').style.display = 'block'; 
        }
        
        function waitForLibraries(cb) {
            if(typeof L !== 'undefined' && typeof proj4 !== 'undefined' && typeof Papa !== 'undefined') {
                log("‚úÖ Todas las librer√≠as cargadas");
                cb();
            } else {
                log("‚è≥ Esperando librer√≠as...");
                setTimeout(() => waitForLibraries(cb), 100);
            }
        }

    </script>
</body>
</html>
