<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Visor Forestal ACOPAC - OSRO</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<style>
body, html {
    margin: 0;
    height: 100%;
    font-family: Inter, sans-serif;
    background: #f3f4f6;
}

/* ================= MODALES ================= */
.modal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.85);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 20000;
    animation: fadeIn .35s ease;
}

.modal-content {
    background: white;
    width: 90%;
    max-width: 600px;
    border-radius: 14px;
    overflow: hidden;
    animation: slideUp .4s ease;
}

@keyframes fadeIn {
    from {opacity:0;}
    to {opacity:1;}
}
@keyframes slideUp {
    from {transform:translateY(30px); opacity:0;}
    to {transform:translateY(0); opacity:1;}
}

.hidden {
    display: none !important;
}

.modal-header {
    padding: 20px;
    background: #f9fafb;
    border-bottom: 1px solid #e5e7eb;
    text-align: center;
    font-weight: 900;
    color: #059669;
}

.modal-body {
    padding: 22px;
    max-height: 65vh;
    overflow-y: auto;
    font-size: 14px;
    line-height: 1.6;
}

.modal-footer {
    display: flex;
    gap: 12px;
    padding: 16px;
    border-top: 1px solid #e5e7eb;
}

button {
    flex: 1;
    padding: 14px;
    border-radius: 8px;
    font-weight: 700;
    border: none;
    cursor: pointer;
}

.btn-ok {
    background: #10b981;
    color: white;
}
.btn-ok:hover {
    background: #059669;
}
.btn-cancel {
    background: #fee2e2;
    color: #b91c1c;
}

/* ================= LOGIN ================= */
.login-box {
    max-width: 420px;
}
select, input {
    width: 100%;
    padding: 12px;
    margin-bottom: 14px;
    border-radius: 8px;
    border: 2px solid #e5e7eb;
    font-size: 14px;
}

#map {
    display: none;
    height: 100vh;
}
</style>
</head>

<body>

<!-- ================= AVISO LEGAL ================= -->
<div id="legal-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            VISOR DE APROVECHAMIENTO FORESTAL<br>ACOPAC - OSRO
        </div>
        <div class="modal-body">
            <p><strong>LEA ATENTAMENTE ANTES DE INGRESAR</strong></p>
            <p>
                Esta herramienta es de uso institucional. El acceso implica
                confidencialidad, uso responsable y aceptación de las
                limitaciones técnicas del sistema.
            </p>
            <p>
                El sistema se encuentra en fase <strong>BETA</strong>.
                Las coordenadas GPS son aproximadas y no sustituyen
                levantamientos oficiales.
            </p>
            <p>
                El uso indebido puede acarrear responsabilidades
                administrativas, civiles y penales.
            </p>
        </div>
        <div class="modal-footer">
            <button class="btn-cancel" onclick="closeApp()">Cancelar</button>
            <button class="btn-ok" onclick="acceptLegal()">Aceptar e ingresar</button>
        </div>
    </div>
</div>

<!-- ================= LOGIN ================= -->
<div id="login-modal" class="modal hidden">
    <div class="modal-content login-box">
        <div class="modal-header">Acceso al sistema</div>
        <div class="modal-body">
            <select id="login-user">
                <option value="">Seleccione usuario</option>
            </select>
            <input type="password" id="login-pin" placeholder="PIN" maxlength="3">
            <div id="login-status" style="display:none;font-size:12px;color:#065f46;margin-bottom:10px;">
                Cargando usuarios…
            </div>
            <button class="btn-ok" onclick="processLogin()">Ingresar</button>
        </div>
    </div>
</div>

<!-- ================= MAPA ================= -->
<div id="map"></div>

<script>
/* ================= CONFIG ================= */
const ADMIN_USER = { name: "Pablo Sánchez", pin: "920", isAdmin: true };
let USERS_DATABASE = {};
let map;

/* ================= CONTROL DE ESTADO ================= */
function lockBackNavigation() {
    history.pushState(null, "", location.href);
    window.onpopstate = function () {
        history.pushState(null, "", location.href);
    };
}

function acceptLegal() {
    localStorage.setItem("legalAccepted", "true");
    lockBackNavigation();

    USERS_DATABASE = {};
    USERS_DATABASE[ADMIN_USER.name] = ADMIN_USER.pin;

    document.getElementById("legal-modal").classList.add("hidden");
    document.getElementById("login-modal").classList.remove("hidden");

    populateLoginSelect();
    loadUsersFromCSV();
}

function closeApp() {
    document.body.innerHTML =
        "<h2 style='text-align:center;margin-top:40px'>Sesión cancelada</h2>";
}

/* ================= LOGIN ================= */
function populateLoginSelect() {
    const sel = document.getElementById("login-user");
    sel.innerHTML = "<option value=''>Seleccione usuario</option>";
    Object.keys(USERS_DATABASE).forEach(u => {
        const o = document.createElement("option");
        o.value = u;
        o.textContent = u;
        sel.appendChild(o);
    });
}

function processLogin() {
    const u = login-user.value;
    const p = login-pin.value;
    if (USERS_DATABASE[u] === p) {
        document.getElementById("login-modal").classList.add("hidden");
        initMap();
    } else {
        alert("PIN incorrecto");
        login-pin.value = "";
    }
}

/* ================= CSV USUARIOS ================= */
function loadUsersFromCSV() {
    const status = document.getElementById("login-status");
    status.style.display = "block";

    // Puedes cambiar esta URL luego desde admin
    const csvURL = "";

    if (!csvURL) {
        status.textContent = "Solo administrador disponible";
        return;
    }

    Papa.parse(csvURL, {
        download: true,
        header: true,
        complete: r => {
            r.data.forEach(row => {
                if (row.usuario && row.pin) {
                    USERS_DATABASE[row.usuario] = row.pin;
                }
            });
            populateLoginSelect();
            status.textContent = "Usuarios cargados";
        }
    });
}

/* ================= MAPA ================= */
function initMap() {
    document.getElementById("map").style.display = "block";
    map = L.map("map").setView([9.9, -84.3], 9);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
}

/* ================= AUTO-INICIO ================= */
window.onload = () => {
    if (localStorage.getItem("legalAccepted") === "true") {
        lockBackNavigation();
        document.getElementById("legal-modal").classList.add("hidden");
        document.getElementById("login-modal").classList.remove("hidden");

        USERS_DATABASE[ADMIN_USER.name] = ADMIN_USER.pin;
        populateLoginSelect();
    }
};
</script>

</body>
</html>
